# Average Treatment Effect of the Treated (ATT)

```{r, message=FALSE, warning=FALSE}
# load required libraries
library(testthat)
library(grf)
library(here)

# source additional scripts from OutcomeWeights directory
skripte <- list.files(
  "../R",  
  pattern = "\\.R$", 
  full.names = TRUE)
for (f in skripte) source(f, local = knitr::knit_global())

getwd()
```

```{r, message=FALSE, warning=FALSE}
# set up sample data
set.seed(1234)
n <- 100   # number of observations
p <- 3     # number of covariates

# generate sample data
X <- matrix(rbinom(n * p, 1, 0.5), n, p)
Z <- rbinom(n, 1, 0.5)  # instrumental variable
Q <- rbinom(n, 1, 0.5)  # random assignment
D <- Q * Z              # treatment assignment

# define true treatment effect and outcomes (ATT-focused)
tau <- X[, 1] / 2
Y_0 <- rowSums(X[, 1:3]) + rnorm(n)  
Y_1 <- Y_0 + tau
Y <- D * Y_1 + (1 - D) * Y_0
```

```{r, message=FALSE, warning=FALSE}
# perform DML for ATT
att_result <- dml_with_smoother(
  Y = Y,
  D = D,
  X = X,
  estimators = c("AIPW_ATT"),  
  smoother = "honest_forest",
  n_reps = 1, 
  n_cf_folds = 2
)

# summarize results
summary_att <- summary(att_result)
print(summary_att)

# validate weights
omega_att <- get_outcome_weights(att_result)
weighted_att <- as.numeric(omega_att$omega["AIPW-ATT", ] %*% Y)  
```

```{r, message=FALSE, warning=FALSE}
# calculate true ATT 
true_att <- mean(tau[D == 1])  

# compare with tolerance
cat("Final validation of AIPW-ATT:", isTRUE(all.equal(weighted_att, true_att, tolerance = 0.2)), "\n")

# print results
true_att
weighted_att
```

# Average Treatment Effect of the Untreated (ATU)

```{r, message=FALSE, warning=FALSE}
# perform DML for ATU
atu_result <- dml_with_smoother(
  Y = Y,
  D = D,
  X = X,
  estimators = c("AIPW_ATU"),  
  smoother = "honest_forest",
  n_reps = 1, 
  n_cf_folds = 2
)

# summarize results
summary_atu <- summary(atu_result)
print(summary_atu)

# validate weights
omega_atu <- get_outcome_weights(atu_result)
weighted_atu <- as.numeric(omega_atu$omega["AIPW-ATU", ] %*% Y)  
```

```{r, message=FALSE, warning=FALSE}
# calculate true ATU 
true_atu <- mean(tau[D == 0]) 

# compare with tolerance
cat("Final validation of AIPW-ATU:", 
    isTRUE(all.equal(weighted_atu, true_atu, tolerance = 0.2)), "\n")

# print results
true_atu
weighted_atu
```

# Average Treatment Effect of the Treated (ATT)

```{r, message=FALSE, warning=FALSE}
# load required libraries
library(testthat)
library(grf)
library(here)

# source additional scripts from OutcomeWeights directory
skripte <- list.files(
  "../R",  
  pattern = "\\.R$", 
  full.names = TRUE)
for (f in skripte) source(f, local = knitr::knit_global())
```

```{r, message=FALSE, warning=FALSE}
# set up sample data
set.seed(1234)
n <- 100   # number of observations
p <- 3     # number of covariates

# generate sample data
X <- matrix(rbinom(n * p, 1, 0.5), n, p)
Z <- rbinom(n, 1, 0.5)  # instrumental variable
Q <- rbinom(n, 1, 0.5)  # random assignment
D <- Q * Z              # treatment assignment

# define true treatment effect and outcomes (ATT-focused)
tau <- X[, 1] / 2 
treatment_effect <- ifelse(D == 1, tau, 0)
Y <- rowSums(X[, 1:3]) + treatment_effect + rnorm(n)  
```

```{r, message=FALSE, warning=FALSE}
# perform DML for ATT
att_result <- dml_with_smoother(
  Y = Y,
  D = D,
  X = X,
  estimators = c("AIPW_ATT"),  
  smoother = "honest_forest",
  n_reps = 1, 
  n_cf_folds = 2
)

# summarize results
summary_att <- summary(att_result)
print(summary_att)

# validate weights
omega_att <- get_outcome_weights(att_result)
weighted_att <- as.numeric(omega_att$omega["AIPW-ATT", ] %*% Y)  

# compare with summary output
expect_equal(
  weighted_att,
  as.numeric(summary_att["AIPW-ATT", "Estimate"]),  
  tolerance = 1e-6
)
```

```{r, message=FALSE, warning=FALSE}
# calculate true ATT 
true_att <- mean(treatment_effect[D == 1])  

# compare with tolerance
cat("Final validation of AIPW-ATT:", isTRUE(all.equal(weighted_att, true_att, tolerance = 0.2)), "\n")
```

# Average Treatment Effect of the Treated (ATU)

```{r, message=FALSE, warning=FALSE}
# set up sample data
set.seed(1234)
n <- 100   # number of observations
p <- 3     # number of covariates

# generate sample data
X <- matrix(rbinom(n * p, 1, 0.5), n, p)
Z <- rbinom(n, 1, 0.5)  # instrumental variable
Q <- rbinom(n, 1, 0.5)  # random assignment
D <- Q * Z              # treatment assignment

# define true treatment effect and outcomes (ATU-focused)
tau <- X[, 1] / 2 
treatment_effect <- ifelse(D == 1, 0, tau_atu)
Y <- rowSums(X[, 1:3]) + treatment_effect + rnorm(n)  
```

```{r, message=FALSE, warning=FALSE}
# perform DML for ATU
atu_result <- dml_with_smoother(
  Y = Y,
  D = D,
  X = X,
  estimators = c("AIPW_ATU"),  
  smoother = "honest_forest",
  n_reps = 1, 
  n_cf_folds = 2
)

# summarize results
summary_atu <- summary(atu_result)
print(summary_atu)

# validate weights
omega_atu <- get_outcome_weights(atu_result)
weighted_atu <- as.numeric(omega_atu$omega["AIPW-ATU", ] %*% Y)  

# compare with summary output
expect_equal(
  weighted_atu,
  as.numeric(summary_atu["AIPW-ATU", "Estimate"]),  
  tolerance = 1e-6
)
```

```{r, message=FALSE, warning=FALSE}
# calculate true ATU 
true_atu <- mean(treatment_effect[D == 0]) 

# compare with tolerance
cat("Final validation of AIPW-ATU:", 
    isTRUE(all.equal(weighted_atu, true_atu, tolerance = 0.2)), "\n")
```

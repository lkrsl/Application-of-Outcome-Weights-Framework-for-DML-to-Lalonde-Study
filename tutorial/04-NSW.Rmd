# LaLonde (NSW) Data 
This section (4) examines the effect of the treatment (participation in the job training program) on the participants’ earnings in 1978 (`re78`) in the original LaLonde dataset (loaded as `nsw`, similar to @imbens2024). 

For detailed explanations of the analysis steps and notes, please refer to section 2. Here, we only explain the NSW–specific results.

## Set up
### Source functions and load data
```{r, message=FALSE, warning=FALSE}
# source functions
source("https://github.com/xuyiqing/lalonde/blob/main/tutorial/functions.R?raw=TRUE")
source("tutorial/functions.R")
```

```{r, message=FALSE, warning=FALSE}
# load data
load("data/lalonde.RData")
load("data/trimmed.RData")
```

```{r, message=FALSE, warning=FALSE}
# set seed
set.seed(42)
```

### Load and preprocess data 
```{r, message=FALSE, warning=FALSE}
treat <- "treat"
nsw_co$treat <- 1

# drop re74, u74, tau from CPS-1 and PSID-1 and merge data
cps1a <- subset(cps1, select =  -c(re74, u74))
nsw_cps <- rbind.data.frame(nsw_tr, cps1a)

psid1a <- subset(psid1, select =  -c(re74, u74))
nsw_psid <- rbind.data.frame(nsw_tr, psid1a)

nsw_cps.plus <- rbind.data.frame(nsw_cps, nsw_co)
nsw_psid.plus <- rbind.data.frame(nsw_psid, nsw_co)
```

### Inspect data
```{r, message=FALSE, warning=FALSE}
# collect samples in a list
data <- list(nsw = nsw, nsw_cps = nsw_cps, nsw_psid = nsw_psid, nsw_cps.plus = nsw_cps.plus, nsw_psid.plus = nsw_psid.plus)

# print and inspect key metrics of each sample
summary_stats <- inspect_data(data)
datatable(summary_stats, caption = "Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

## NSW
```{r, message=FALSE, warning=FALSE}
# define variables
Y <- "re78" 
treat <- "treat" 
covar <- c("age", "education", "black", "hispanic", "married", 
           "nodegree", "re75", "u75")
```

### Pre-assessing methods 
#### Overlap
```{r, fig.cap='FIGUREC1. SubfigureA:NSW-Experimental. SubfigureB:NSW-CPS1. SubfigureC:NSW-PSID1.',out.width='100%', fig.asp=0.5}
nsw_ps <- assess_overlap(data = nsw, treat = treat, cov = covar, xlim = c(-2, 1.5))
nsw_cps_ps <- assess_overlap(data = nsw_cps, treat = treat, cov = covar, xlim = c(-15, 5))
nsw_psid_ps <- assess_overlap(data = nsw_psid, treat = treat, cov = covar, xlim = c(-15, 5))
```

As anticipated, the NSW-Experimental data exhibits an almost perfect overlap. In contrast, the observational samples NSW-CPS1 and NSW-PSID1 show poor overlap. 
```{r, fig.cap='FIGUREC1. SubfigureD:NSW-CPS1-PLUS. SubfigureE:NSW-PSID1-PLUS.', out.width='80%', fig.asp=1, fig.align='center'}
nsw_cps.plus_ps <- assess_overlap(data = nsw_cps.plus, treat = treat, cov = covar, xlim = c(-15, 5))
nsw_psid.plus_ps <- assess_overlap(data = nsw_psid.plus, treat = treat, cov = covar, xlim = c(-15, 5))
```

With the expanded datasets NSW-CPS1-PLUS and NSW-PSID1-PLUS, it is evident that the degree of overlap between treated and control groups has improved, as seen by a greater coverage of log-odds densities across both samples.
```{r, message=FALSE, warning=FALSE}
# combine results
data_list <- list(nsw, nsw_cps, nsw_psid, nsw_cps.plus, nsw_psid.plus)
plot_titles <- c("(A) NSW-Experimental","(B) NSW-CPS-1", "(C) NSW-PSID-1", "(D) NSW-CPS-1-PLUS", "(E) NSW-PSID-1-PLUS")

# save results
save_overlap_panels(
  data_list = data_list,
  treat     = treat,
  covar     = covar,
  plot_titles = plot_titles,
  prefix = "nsw_overlap_panels"
)
```

```{r}
# set model formula
model <- as.formula(paste(treat, "~", paste(covar, collapse = " + ")))
```

<div class="callout-note">
In the subsequent analysis, the primary focus is on improving overlap between treated and control groups. However, covariate imbalance is also addressed, as it may induce bias in estimated treatment effects. Only the original observational samples NSW-CPS-1 and NSW-PSID-1 are considered. The NSW-CPS-1-PLUS and NSW-PSID1-PLUS samples are included exclusively for comparison and replication purposes. The NSW-Experimental data is only consulted as benchmark, as randomization already ensures adequate overlap. 
</div>

## Improving overlap
### Single methods
#### Trimming 
1) Propensity score threshold trimming 
```{r, message=FALSE, warning=FALSE}
# apply trimming with a threshold 
nsw_cps.ps_trim <- ps_trim(nsw_cps_ps, threshold = 0.9)
nsw_psid.ps_trim <- ps_trim(nsw_psid_ps, threshold = 0.9)

# re-estimate propensity scores on trimmed data 
nsw_cps.ps_trim <- ps_estimate(data = nsw_cps.ps_trim, treat = "treat", cov = covar)
nsw_psid.ps_trim <- ps_estimate(data = nsw_psid.ps_trim, treat = "treat", cov = covar)
```

2) Common range trimming
```{r, message=FALSE, warning=FALSE}
# trim observations outside the common support region of propensity scores
nsw_cps.ps_common   <- common_range_trim(nsw_cps_ps)
nsw_psid.ps_common  <- common_range_trim(nsw_psid_ps)

# re-estimate propensity scores on trimmed data 
nsw_cps.ps_common <- ps_estimate(data = nsw_cps.ps_common, treat = "treat", cov = covar)
nsw_psid.ps_common <- ps_estimate(data = nsw_psid.ps_common, treat = "treat", cov = covar)
```

3) Crump trimming 
```{r, message=FALSE, warning=FALSE}
# trim observations with propensity scores outside an interval
nsw_cps.ps_crump  <- crump_trim(nsw_cps_ps, lower = 0.1, upper = 0.9)
nsw_psid.ps_crump <- crump_trim(nsw_psid_ps, lower = 0.1, upper = 0.9)

# re-estimate propensity scores on trimmed data 
nsw_cps.ps_crump <- ps_estimate(data = nsw_cps.ps_crump, treat = "treat", cov = covar)
nsw_psid.ps_crump <- ps_estimate(data = nsw_psid.ps_crump, treat = "treat", cov = covar)
```

4) Stuermer trimming
```{r, message=FALSE, warning=FALSE}
# trim observations based on propensity score quantiles separately for treated and control
nsw_cps.ps_stuermer  <- stuermer_trim(nsw_cps_ps, lower_percentile = 0.05, upper_percentile = 0.95)
nsw_psid.ps_stuermer <- stuermer_trim(nsw_psid_ps, lower_percentile = 0.05, upper_percentile = 0.95)

# re-estimate propensity scores on trimmed data 
nsw_cps.ps_stuermer <- ps_estimate(data = nsw_cps.ps_stuermer, treat = "treat", cov = covar)
nsw_psid.ps_stuermer <- ps_estimate(data = nsw_psid.ps_stuermer, treat = "treat", cov = covar)
```

5) Walker trimming
```{r, message=FALSE, warning=FALSE}
# trim observations based on preference scores that adjust for treatment prevalence using logit transformations
nsw_cps.ps_walker   <- walker_trim(nsw_cps_ps)
nsw_psid.ps_walker  <- walker_trim(nsw_psid_ps)

# re-estimate propensity scores on trimmed data 
nsw_cps.ps_walker <- ps_estimate(data = nsw_cps.ps_walker, treat = "treat", cov = covar)
nsw_psid.ps_walker <- ps_estimate(data = nsw_psid.ps_walker, treat = "treat", cov = covar)
```

### Integrated methods
#### Trimming and matching 
##### Extended datasets 
(Similar to tutorial by @imbens2024)
```{r, message=FALSE, warning=FALSE}
nsw_cps_trim <- ps_trim(nsw_cps.plus_ps, threshold = 0.85)
nsw_psid_trim <- ps_trim(nsw_psid.plus_ps, threshold = 0.85)

# excluding the experimental controls
nsw_cps_trim_match <- subset(nsw_cps_trim, sample %in% c(0,3) & ps_assoverlap)
nsw_psid_trim_match <- subset(nsw_psid_trim, sample %in% c(0,4) & ps_assoverlap)

# re-estimate propensity scores on trimmed data 
nsw_cps_trim_match <- psmatch(data = nsw_cps_trim_match, Y = "re78", treat = "treat", cov = covar)
nsw_psid_trim_match <- psmatch(data = nsw_psid_trim_match, Y = "re78", treat = "treat", cov = covar)

# further subset data and re-assign treat variable 
nsw_trim_cps <- subset(nsw_cps_trim, sample %in% c(0,0.5))
nsw_trim_cps$treat[which(nsw_trim_cps$sample == 0.5)] <- 0

nsw_trim_psid <- subset(nsw_psid_trim, sample %in% c(0,0.5))
nsw_trim_psid$treat[which(nsw_trim_psid$sample == 0.5)] <- 0
```

##### Initial datasets
```{r, message=FALSE, warning=FALSE}
# combine trimmed samples
all_trim.cps  <- list(
  ps_threshold = nsw_cps.ps_trim, 
  common_range = nsw_cps.ps_common, 
  stuermer = nsw_cps.ps_stuermer, 
  walker = nsw_cps.ps_walker, 
  crump = nsw_cps.ps_crump)

all_trim.psid  <- list(
  ps_threshold = nsw_psid.ps_trim, 
  common_range = nsw_psid.ps_common, 
  stuermer = nsw_psid.ps_stuermer, 
  walker = nsw_psid.ps_walker, 
  crump = nsw_psid.ps_crump)
```

###### Distance matching
1) 1:1 Nearest neighbor matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with k=1, logistic propensity score and replacement
nn_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", replace = TRUE)
nn_trim_comb.psid <- attach_matchit(model, data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", replace = TRUE)
```

2) k:1 matching (k=2) with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with k=2, logistic propensity score and replacement
k<-2
k2_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
k2_trim_comb.psid <- attach_matchit(model, data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
```

3) k:1 matching (k=3) with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with k=3, logistic propensity score and replacement
k<-3
k3_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
k3_trim_comb.psid <- attach_matchit(model, data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
```

4) Caliper matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with a caliper of 0.1 on the logistic propensity score 
caliper_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", caliper = 0.1, replace = TRUE)
caliper_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", caliper = 0.1, replace = TRUE)
```

5) Common support restriction matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with exclusion of units outside common support
cs_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", discard = "both", reestimate = TRUE, replace = TRUE)
cs_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", discard = "both", reestimate = TRUE, replace = TRUE)
```

6) Mahalanobis distance matching (mahvars) with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching using mahalanobis distance
mahvars_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "mahalanobis", replace = FALSE)
mahvars_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "nearest", distance = "mahalanobis", replace = FALSE)
```

7) Optimal pair matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform optimal pair matching that minimizes total within-pair distance on propensity scores
optimal_pair_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "optimal", distance = "glm", link = "logit")
optimal_pair_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "optimal", distance = "glm", link = "logit")
```

8) Optimal full matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform optimal full matching allowing sets with varying ratios of treated to controls and minimizing a global distance criterion
optimal_full_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "full", distance = "glm", link = "logit")
optimal_full_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "full", distance = "glm", link = "logit")
```

9) Generalized full matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform generalized full matching using fast approximation and producing matched sets with flexible treated/control ratios 
general_full_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "quick", distance = "glm", link = "logit")
general_full_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "quick", distance = "glm", link = "logit")
```

10) Genetic matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform genetic matching 
genetic_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "genetic", distance = "glm", link = "logit", replace = TRUE, pop.size = 100)
genetic_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "genetic", distance = "glm", link = "logit", replace = TRUE, pop.size = 100)
```

###### Stratum matching
11) Exact matching (exact)
```{r, message=FALSE, warning=FALSE}
# match units exactly by raw covariate profiles 
exact_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "exact")
exact_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "exact")
```

12) Coarsened matching (cem)
```{r, message=FALSE, warning=FALSE}
# match units exactly within coarse strata 
cem_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "cem")
cem_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "cem")
```

13) Subclassification 
```{r, message=FALSE, warning=FALSE}
# partition sample into fixed number of bins based on propensity score 
subcl_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "subclass", subclass = 3)
subcl_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "subclass", subclass = 3)
```

###### Pure subset selection
14) Cardinality profile matching
```{r, message=FALSE, warning=FALSE}
# select largest balanced subsample meeting covariate balance tolerances and a fixed ratio of controls to treated units
card_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "cardinality", tols = 0.1, ratio = 1, time = 1200)
card_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "cardinality", tols = 0.1, ratio = 1, time = 1200)
```

15) Profile matching
```{r, message=FALSE, warning=FALSE}
# select the largest control group subset balanced to the treated group (for ATT), leaving the treated group intact
profile_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "cardinality", estimand = "ATT", tols = 0.1, ratio = NA, time = 1200)
profile_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "cardinality", estimand = "ATT", tols = 0.1, ratio = NA, time = 1200)
```

## Post-assessing methods
### Single methods
#### Trimming
##### SMD
```{r, message=FALSE, warning=FALSE}
# compute absolute standardized mean differences
smd_trim.cps <- compute_abs_smd_trim(all_trim.cps, "treat", covar)
smd_trim.psid <- compute_abs_smd_trim(all_trim.psid, "treat", covar)
```

##### OVL
```{r, message=FALSE, warning=FALSE}
# compute overlap coefficients
ovl_trim.cps <- compute_ovl_trim(all_trim.cps, "ps_assoverlap", "treat")
ovl_trim.psid <- compute_ovl_trim(all_trim.psid, "ps_assoverlap", "treat")
```

### Integrated methods
#### Trimming and matching
##### Extended samples
(Similar to tutorial by @imbens2024)
```{r, message=FALSE, warning=FALSE}
# list all trimmed and matched samples
trim_match_comb.cps_plus <- list(ps_threshold_match = nsw_cps_trim_match)
trim_match_comb.psid_plus <- list(ps_threshold_match = nsw_psid_trim_match)
```

###### SMD
```{r, message=FALSE, warning=FALSE}
# compute absolute standardized mean differences
smd_trim_match_comb.cps_plus <- compute_abs_smd_trim(trim_match_comb.cps_plus, "treat", covar)
smd_trim_match_comb.psid_plus <- compute_abs_smd_trim(trim_match_comb.psid_plus, "treat", covar)
```

###### OVL
```{r, message=FALSE, warning=FALSE}
# compute overlap coefficients
ovl_trim_match_comb.cps_plus <- compute_ovl_trim(trim_match_comb.cps_plus, "ps_assoverlap", "treat")
ovl_trim_match_comb.psid_plus <- compute_ovl_trim(trim_match_comb.psid_plus, "ps_assoverlap", "treat")
```

##### Initial samples
```{r, message=FALSE, warning=FALSE}
# list all trimmed and matched samples
trim_match_comb.cps <- list(
  nn = nn_trim_comb.cps, 
  k2 = k2_trim_comb.cps,
  k3 = k3_trim_comb.cps, 
  caliper = caliper_trim_comb.cps,
  cs = cs_trim_comb.cps, 
  mahvars = mahvars_trim_comb.cps,
  optimal_pair = optimal_pair_trim_comb.cps,
  optimal_full = optimal_full_trim_comb.cps, 
  genetic = genetic_trim_comb.cps, 
  exact = exact_trim_comb.cps,
  cem = cem_trim_comb.cps,
  subcl = subcl_trim_comb.cps 
)

trim_match_comb.psid <- list(
  nn = nn_trim_comb.psid,
  k2 = k2_trim_comb.psid, 
  k3 = k3_trim_comb.psid, 
  caliper = caliper_trim_comb.psid, 
  cs = cs_trim_comb.psid,
  mahvars = mahvars_trim_comb.psid,
  optimal_pair = optimal_pair_trim_comb.psid, 
  optimal_full = optimal_full_trim_comb.psid, 
  genetic = genetic_trim_comb.psid,
  exact = exact_trim_comb.psid,
  cem = cem_trim_comb.psid,
  subcl = subcl_trim_comb.psid 
)
```

###### SMD
```{r, message=FALSE, warning=FALSE}
# compute absolute standardized mean differences
smd_trim_match_comb.cps <- compute_abs_smd_matchit(trim_match_comb.cps, all_trim.cps) 
smd_trim_match_comb.psid <- compute_abs_smd_matchit(trim_match_comb.psid, all_trim.psid)
```

###### OVL
```{r, message=FALSE, warning=FALSE}
# compute overlap coefficients
ovl_trim_match_comb.cps <- compute_ovl_matchit(trim_match_comb.cps, all_trim.cps, ps = "ps_assoverlap", treat = "treat", covar = covar)
ovl_trim_match_comb.psid <- compute_ovl_matchit(trim_match_comb.psid, all_trim.psid, ps = "ps_assoverlap", treat = "treat", covar = covar)
```

## Identifying most efficient methods
### Ranking
```{r, message=FALSE, warning=FALSE}
# combine all results
all_cps <- combine_results("cps")
all_psid <- combine_results("psid") 
```

```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(all_cps, "nsw_cps1_all_results")
save_csv(all_psid, "nsw_psid1_all_results")
```

```{r, message=FALSE, warning=FALSE}
# rank methods 
ranked_cps  <- assess_methods(all_cps)
ranked_psid <- assess_methods(all_psid)

# get top 5 methods 
top5_methods.cps <- get_top_methods(ranked_cps, top_n = 5)
top5_methods.psid <- get_top_methods(ranked_psid, top_n = 5)

# rerank top 5 methods
top5_methods.cps <- rerank_methods(top5_methods.cps, ranked_cps)
top5_methods.psid <- rerank_methods(top5_methods.psid, ranked_psid)
```

```{r, message=FALSE, warning=FALSE}
# get results
top5_methods_df.cps <- ranked_cps %>% arrange(desc(OVL)) %>% head(5) %>% arrange(Mean_Abs_SMD)
top5_methods_df.psid <- ranked_psid %>% arrange(desc(OVL)) %>% head(5) %>% arrange(Mean_Abs_SMD)

# print table output 
datatable(top5_methods_df.cps, caption = "Top 5 Methods for CPS-1", options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
datatable(top5_methods_df.psid, caption = "Top 5 Methods for PSID-1", options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(top5_methods.cps, "nsw_cps1_top5_methods")
save_csv(top5_methods.psid, "nsw_psid1_top5_methods")
```

The table shows that NSW-CPS-1 and NSW-PSID-1 share only one top method, all others are based on various trimming and matching methods. 

### Sample construction
```{r, message=FALSE, warning=FALSE}
# create lookup lists
trim_only_cps <- list(
        ps_threshold = nsw_cps.ps_trim,
        common_range = nsw_cps.ps_common,
        stuermer = nsw_cps.ps_stuermer,
        walker = nsw_cps.ps_walker,
        crump = nsw_cps.ps_crump
)

match_lookup_cps <- c(
        wrap_match_entries(nn_trim_comb.cps, all_trim.cps, "nn"),
        wrap_match_entries(k2_trim_comb.cps, all_trim.cps, "k2"),
        wrap_match_entries(k3_trim_comb.cps, all_trim.cps, "k3"),
        wrap_match_entries(caliper_trim_comb.cps, all_trim.cps, "caliper"),
        wrap_match_entries(cs_trim_comb.cps, all_trim.cps, "cs"),
        wrap_match_entries(mahvars_trim_comb.cps, all_trim.cps, "mahvars"),
        wrap_match_entries(optimal_pair_trim_comb.cps, all_trim.cps, "optimal_pair"),
        wrap_match_entries(optimal_full_trim_comb.cps, all_trim.cps, "optimal_full"),
        wrap_match_entries(genetic_trim_comb.cps, all_trim.cps, "genetic"),
        wrap_match_entries(exact_trim_comb.cps, all_trim.cps, "exact"),
        wrap_match_entries(cem_trim_comb.cps, all_trim.cps, "cem"),
        wrap_match_entries(subcl_trim_comb.cps, all_trim.cps, "subcl")
)

trim_only_psid <- list(
        ps_threshold = nsw_psid.ps_trim,
        common_range = nsw_psid.ps_common,
        stuermer = nsw_psid.ps_stuermer,
        walker = nsw_psid.ps_walker,
        crump = nsw_psid.ps_crump
)

match_lookup_psid <- c(
        wrap_match_entries(nn_trim_comb.psid, all_trim.psid, "nn"),
        wrap_match_entries(k2_trim_comb.psid, all_trim.psid, "k2"),
        wrap_match_entries(k3_trim_comb.psid, all_trim.psid, "k3"),
        wrap_match_entries(caliper_trim_comb.psid, all_trim.psid, "caliper"),
        wrap_match_entries(cs_trim_comb.psid, all_trim.psid, "cs"),
        wrap_match_entries(mahvars_trim_comb.psid, all_trim.psid, "mahvars"),
        wrap_match_entries(optimal_pair_trim_comb.psid, all_trim.psid, "optimal_pair"),
        wrap_match_entries(optimal_full_trim_comb.psid, all_trim.psid, "optimal_full"),
        wrap_match_entries(genetic_trim_comb.psid, all_trim.psid, "genetic"),
        wrap_match_entries(exact_trim_comb.psid, all_trim.psid, "exact"),
        wrap_match_entries(cem_trim_comb.psid, all_trim.psid, "cem"),
        wrap_match_entries(subcl_trim_comb.psid, all_trim.psid, "subcl")
)

list_cps <- c(trim_only_cps, match_lookup_cps)
list_psid <- c(trim_only_psid, match_lookup_psid)
```

```{r, message=FALSE, warning=FALSE}
# create samples corresponding to the top 5 methods for each dataset
top5_datasets.cps <- create_top5_datasets(list_cps, top5_methods.cps)
top5_datasets.psid <- create_top5_datasets(list_psid, top5_methods.psid)

# extract top5 objects
top5_objects.cps <- lapply(top5_methods.cps, function(m) list_cps[[m]])
top5_objects.psid <- lapply(top5_methods.psid, function(m) list_psid[[m]])
```

```{r, message=FALSE, warning=FALSE}
# save samples into .RData files
save_top5_datasets(list_cps, top5_methods.cps, prefix = "nsw_cps1")
save_top5_datasets(list_psid, top5_methods.psid, prefix = "nsw_psid1")
```

## Estimating
### Average treatment effect on the treated (ATT)
```{r, message=FALSE, warning=FALSE}
# estimate ATT
out1 <- estimate_all(nsw, "re78", "treat", covar)
out2 <- estimate_all(nsw_cps, "re78", "treat", covar)
out3 <- estimate_all(nsw_psid, "re78", "treat", covar)

out.cps <- lapply(top5_datasets.cps, function(d) estimate_all(d, "re78", "treat", covar))
out.psid <- lapply(top5_datasets.psid, function(d) estimate_all(d, "re78", "treat", covar))
out.cps_trim <- lapply(all_trim.cps, function(d) estimate_all(d, "re78", "treat", covar))
out.psid_trim <- lapply(all_trim.psid, function(d) estimate_all(d, "re78", "treat", covar))
```

```{r, message=FALSE, warning=FALSE}
# estimate ATT
out4 <- estimate_all(nsw_trim_cps, "re78", "treat", covar)
out5 <- estimate_all(nsw_trim_psid, "re78", "treat", covar)
out6 <- estimate_all(nsw_cps_trim_match, "re78", "treat", covar)
out7 <- estimate_all(nsw_psid_trim_match, "re78", "treat", covar)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGUREC2. SubfigureA:NSW-Experimental. SubfigureB:NSW-CPS1. SubfigureC:NSW-PSID1. SubfigureD-H:Top-NSW-CPS1. SubfigureI-M:Top-NSW-PSID1. SubfigureN:NSW-CPS1-PLUS. SubfigureO:NSW-PSID1-PLUS. ATT Estimates Given Unconfoundedness using NSW Samples"}
par(mfrow = c(4, 1), mar = c(4, 4, 2, 1))

# experimental benchmarks
band.exp <- out1[1, 3:4]
est.exp  <- out1[1, 1]

# plot results
plot_coef(out1,  band = band.exp, line = est.exp, 
          ylim = c(-15500, 5500), main = "(A) NSW-Experimental")

plot_coef(out2,  band = band.exp, line = est.exp, 
          ylim = c(-15500, 5500), main = "(B) NSW-CPS-1")

plot_coef(out3,  band = band.exp, line = est.exp,
          ylim = c(-15500, 5500), main = "(C) NSW-PSID-1")

# get nonexperimtenal benchmarks
method_names_cps <- sapply(top5_methods.cps, function(m) {
    matches <- names(out.cps_trim)[sapply(names(out.cps_trim), function(n) grepl(n, m, fixed=TRUE))]
    if (length(matches) > 0) matches[which.max(nchar(matches))] else NA 
})
method_names_psid <- sapply(top5_methods.psid, function(m) {
    matches <- names(out.cps_trim)[sapply(names(out.cps_trim), function(n) grepl(n, m, fixed=TRUE))]
    if (length(matches) > 0) matches[which.max(nchar(matches))] else NA 
})

band.cps <- lapply(method_names_cps, function(j) out.cps_trim[[j]][1, 3:4])
est.cps  <- lapply(method_names_cps, function(j) out.cps_trim[[j]][1, 1])
band.psid <- lapply(method_names_psid, function(j) out.psid_trim[[j]][1, 3:4])
est.psid  <- lapply(method_names_psid, function(j) out.psid_trim[[j]][1, 1])

# plot results
for (i in seq_along(out.cps)) {
  this_title <- paste0("(", LETTERS[i+3], ") Top CPS-1: ", top5_methods.cps[i])
  plot_coef(out.cps[[i]], band = band.cps[[i]], line = est.cps[[i]],
            ylim = c(-15500, 5500), main = this_title)
}

for (i in seq_along(out.psid)) {
  this_title <- paste0("(", LETTERS[i+8], ") Top PSID-1: ", top5_methods.psid[i])
  plot_coef(out.psid[[i]], band = band.psid[[i]], line = est.psid[[i]],
            ylim = c(-15500, 5500), main = this_title)
}

# nonexperimtenal benchmarks
band.cps_plus <- out4[1, 3:4]
est.cps_plus <- out4[1, 1]
band.psid_plus <- out5[1, 3:4]
est.psid_plus <- out5[1, 1]

# plot results
plot_coef(out6, band = band.cps_plus, line = est.cps_plus, 
          ylim = c(-15500, 5500), main = "(N) Trimmed NSW-CPS-1-PLUS")


plot_coef(out7, band = band.psid_plus, line = est.psid_plus, 
          ylim = c(-15500, 5500), main = "(O) Trimmed NSW-PSID-1-PLUS")

```

```{r, message=FALSE, warning=FALSE}
# get outputs
all_outs <- c(list(out1, out2, out3), out.cps, out.psid, list(out6, out7))

# get plot titles
all_plot_titles <- c("(A) NSW-Experimental", "(B) NSW-CPS1", "(C) NSW-PSID1",
                      paste0("(", LETTERS[4:8], ") Top CPS1: ", top5_methods.cps),
                      paste0("(", LETTERS[9:13], ") Top PSID1: ", top5_methods.psid),
                      "(N) Trimmed NSW-CPS1-PLUS", "(O) Trimmed NSW-PSID1-PLUS")

# get confidence interval bounds
all_bands <- c(list(band.exp, band.exp, band.exp), band.cps, band.psid, list(band.cps_plus, band.psid_plus))

all_ests <- c(list(est.exp, est.exp, est.exp), est.cps, est.psid, list(est.cps_plus, est.psid_plus))

# save results
save_att_panels(
    out_list    = all_outs,
    plot_titles = all_plot_titles,
    band_list   = all_bands,
    est_list    = all_ests,
    prefix      = "nsw_est_comb"
)
```

The above figures show the ATT estimates and their 95% confidence intervals for fifteen samples: NSW-Experimental, NSW-CPS-1, NSW-PSID-1, trimmed and matched versions of the NSW-CPS-1-PLUS and NSW-PSID1-PLUS samples (analogous to Imbens & Xu (2024)) and a series of top-ranked subsamples of both NSW-CPS-1 and NSW-PSID-1 based on various trimming and integrated trimming and matching criteria.

Figure (A) presents the benchmark from the experimental sample (NSW-Experimental), serving as a reference for bias and variance assessment of observational samples. Figures (B) and (C) show results for the observational samples, NSW-CPS-1 and NSW-PSID-1, while figures (N) and (O) present those for the trimmed and matched versions of NSW-CPS-1-PLUS and NSW-PSID-1-PLUS, respectively, replicating the tutorial results of Imbens & Xu (2024). Figures (D) through (H) display results for NSW-CPS1-based subsamples constructed with the top-ranked methods. Analogously, figures (I) through (M) summarize results for the corresponding NSW-PSID-1-based subsamples under parallel rules.

Across the NSW-CPS-1 and its top-ranked subsamples, only in the `genetic_crump` and `cem_crump` subsample all estimators produce ATT estimates that closely align with the benchmark, though some estimates are negative. Some larger deviations from the benchmark occur for the `optimal_pair_walker`, `nn_walker` and `k3_walker` subsamples. Nevertheless, these ATT estimates deviate relatively more from the benchmark than those obtained under models A and B in previous sections using LDW data.

In comparison, NSW-PSID-1-based subsamples exhibit significantly greater deviation and substantially higher standard errors than the NSW-CPS-1 samples, consistent with previous observations from LDW data. All their ATT estimates remain negatively aligned, reflecting heightened methodological uncertainty within these samples.
```{r, message=FALSE, warning=FALSE}
# evaluate results
all_summaries <- lapply(all_outs, eval_att)
att_summary <- do.call(rbind, all_summaries)
rownames(att_summary) <- all_plot_titles

# print table output
datatable(att_summary, caption = "ATT Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

```{r, message=FALSE, warning=FALSE}
# create result matrix
out.cps_top <- lapply(method_names_cps, function(j) out.cps_trim[[j]])
out.psid_top <- lapply(method_names_psid, function(j) out.psid_trim[[j]])
all_out_mat <- c(list(out1), out.cps_top, out.psid_top, list(out4, out5))
result_mat <- create_matrix_results(all_outs, all_out_mat, all_plot_titles)

# print table output
datatable(result_mat, caption = "ATT Estimates and SEs",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

The tabulated results confirm visual patterns: Column (A) reports the estimates for the NSW-Experimental sample, column (B) for the NSW-CPS-1 sample, and column (C) for the NSW-PSID-1 sample. Columns (D)-(M) summarize results for the top-ranked subsamples for both NSW-CPS-1 and NSW-PSID1. Columns (N) and (O) report results for the trimmed and matched versions of NSW-CPS-1-PLUS and NSW-PSID-1-PLUS sample, respectively.

For most NSW-CPS-1-based samples, ATT estimates remain negative. The subsample `genetic_crump` and `cem_crump` exhibit frequently positive estimates and are relatively close to the benchmark. In contrast, the NSW-PSID-1-based estimates exhibit larger negative magnitudes, and increased standard errors, underscoring the heightened difficulty of achieving consistent ATT effect estimates in this observational dataset. 

Overall, consistent with findings from models A and B, figures and table jointly demonstrate that ATT estimates from observational samples tend to have larger standard errors compared to the experimental sample, reflecting greater statistical uncertainty in non-experimental causal effect estimation, and that certain methods can bring observational estimates closer to the benchmark. 
```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(result_mat, "nsw_att_estimates")
```

### Conditional average treatment effect on the treated (CATT)
```{r, message=FALSE, warning=FALSE}
# estimate CATT
catt.nsw <- catt(nsw, Y, treat, covar)
catt.cps <- catt(nsw_cps, Y, treat, covar)
catt.psid <- catt(nsw_psid, Y, treat, covar)
catt.top5_cps <- lapply(top5_datasets.cps, function(d) catt(d, Y, treat, covar))
catt.top5_psid <- lapply(top5_datasets.psid, function(d) catt(d, Y, treat, covar))
catt.top5_cps_trim <- lapply(all_trim.cps, function(d) catt(d, Y, treat, covar))
catt.top5_psid_trim <- lapply(all_trim.psid, function(d) catt(d, Y, treat, covar))
```

```{r, message=FALSE, warning=FALSE}
catt.cps.trim <- catt(nsw_cps_trim_match, Y, treat, covar)
catt.psid.trim <- catt(nsw_psid_trim_match, Y, treat, covar)
catt.nsw.cps <- catt(nsw_trim_cps, Y, treat, covar)
catt.nsw.psid <- catt(nsw_trim_psid, Y, treat, covar)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGUREC3. SubfigureB:NSW-CPS-1. SubfigureC:NSW-PSID-1. SubfigureD-H:Top-NSW-CPS-1. SubfigureI-M:Top-NSW-PSID-1. SubfigureN:NSW-CPS-1-PLUS. SubfigureO:NSW-PSID-1-PLUS. CATT Estimates using NSW Data: Experimental vs. Nonexperimental"}
# plot results
par(mfrow = c(2,2)) 
par(cex.main = 0.9)

plot_catt(
  catt1 = catt.nsw$catt,
  catt2 = catt.cps$catt,
  att1  = catt.nsw$att[1],
  att2  = catt.cps$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (CPS-1)",
  main  = "(B) NSW-CPS-1", 
  axes.range = c(-8000, 8000)
)

plot_catt(
  catt1 = catt.nsw$catt,
  catt2 = catt.psid$catt,
  att1  = catt.nsw$att[1],
  att2  = catt.psid$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (PSID-1)",
  main  = "(C) NSW-PSID-1",
  axes.range = c(-8000, 8000)
)

plot_catt_panels(
  exp_catt = catt.top5_cps_trim,
  catt_list  = catt.top5_cps,
  plot_titles = paste0("(", LETTERS[4:8], ") Top CPS-1: ", top5_methods.cps)
)

plot_catt_panels(
  exp_catt = catt.top5_psid_trim,
  catt_list  = catt.top5_psid,
  plot_titles = paste0("(", LETTERS[9:13], ") Top PSID-1: ", top5_methods.psid)
)

plot_catt(
  catt1 <- catt.nsw.cps$catt,
  catt2 <- catt.cps.trim$catt,
  att1 <- catt.nsw.cps$att[1],
  att2 <- catt.cps.trim$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (CPS-1-PLUS-Trimmed)",
  main  = "(N) Trimmed NSW-CPS-1-PLUS", 
  axes.range = c(-8000, 8000)
)

plot_catt(
  catt1 <- catt.nsw.psid$catt,
  catt2 <- catt.psid.trim$catt,
  att1 <- catt.nsw.psid$att[1],
  att2 <- catt.psid.trim$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (PSID-1-PLUS-Trimmed)",
  main  = "(O) Trimmed NSW-PSID-1-PLUS",
  axes.range = c(-8000, 8000)
)
```

```{r, out.width='100%', fig.asp=1.}
# combine all catt objects 
all_catt <- c(list(catt.nsw, catt.cps, catt.psid), 
              catt.top5_cps, catt.top5_psid, 
              list(catt.cps.trim, catt.psid.trim))

# evaluate results
all_catt_eval <- eval_catt(all_catt, all_plot_titles)

# print table output
datatable(all_catt_eval, caption = "CATT Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

With NSW-CPS-1, the CATT estimates range from $-8,994.51 to $6,328.35, contrasting with the benchmark where CATT estimates span from $-1,146.76 to $3,347.6, with a mean CATT estimate of $814.53. Unlike in the previous sections, the NSW-PSID-1 data exhibits a narrower CATT estimates range compared to NSW-CPS-1, spanning from $-8,179.54 to $867,51. Yet its mean CATT estimate remains substantially negative, at approximately $-2,364.14, contrary to the positive mean CATT estimates observed in models A and B.

Among the top-ranked NSW-CPS-1 subsamples, CATT estimates exhibit substantial variability. Subsamples such as `optimal_pair_walker`, `nn_walker` or `k3_walker` yield notably negative minimum CATT values alongside substantial negative mean CATT estimates. Similarly, `genetic_crump` and `cem_crump` subsamples produce consistently negative CATT estimates, whereas their mean CATT estimates are positive and closer to the benchmark.

The NSW-PSID-1 top-ranked subsamples deliver substantially decreased mean CATT estimates, reflecting greater difficulties in producing reliable effect estimates, while producing narrower extremes compared to the NSW-CPS-1 subsamples.

This variation in range and means across samples, as observed in previous sections, reflects substantial heterogeneity in treatment effect estimation across observational samples but also indicates that while certain criteria improve alignment with the experimental benchmark, others introduce considerable discrepancies and spread in estimated heterogeneous effects.
```{r, message=FALSE, warning=FALSE}
# save results
save_main_catt_panels(
  catt_refs = list(catt.nsw),
  catt_comps = list(catt.cps, catt.psid),
  ylabels = c("CATT (CPS-1)", "CATT (PSID-1)"),
  prefix = "nsw_catt_main_panels",
  main_titles = c("(B) NSW-CPS-1", "(C) NSW-PSID-1")
)

save_catt_panels(
  exp_catt = catt.top5_cps_trim,
  catt_list  = catt.top5_cps,
  plot_titles = paste0("(", LETTERS[4:8], ") Top CPS-1: ", top5_methods.cps),
  prefix = "nsw_catt_top5_cps"
)

save_catt_panels(
  exp_catt = catt.top5_psid_trim,
  catt_list  = catt.top5_psid,
  plot_titles = paste0("(", LETTERS[9:13], ") Top PSID-1: ", top5_methods.psid),
  prefix = "nsw_catt_top5_psid"
)

save_plus_catt_panels(
  catt1_list = list(catt.nsw.cps, catt.nsw.psid),
  catt2_list = list(catt.cps.trim, catt.psid.trim),
  ylabels = c("CATT (CPS-1-PLUS-Trimmed)", "CATT (PSID-1-PLUS-Trimmed)"),
  prefix = "nsw_catt_plus_panels",
  main_titles = c("(N) Trimmed NSW-CPS-1-PLUS", "(O) Trimmed NSW-PSID-1-PLUS"),
  folder = "graphs/lalonde"
)
```

### Quantile treatment effect on the treated (QTET)
```{r, message=FALSE, warning=FALSE}
qte.nsw <- est_qte(Y, treat, covar, data = nsw, cores = 4)
qte.nsw_cps <- est_qte(Y, treat, covar, data = nsw_cps)
qte.nsw_psid <- est_qte(Y, treat, covar, data = nsw_psid)
qte.top5_cps  <- lapply(top5_datasets.cps,  function(d) est_qte(Y, treat, covar, data = d))
qte.top5_psid <- lapply(top5_datasets.psid, function(d) est_qte(Y, treat, covar, data = d))
qte.top5_cps_trim  <- lapply(all_trim.cps,  function(d) est_qte(Y, treat, covar, data = d))
qte.top5_psid_trim <- lapply(all_trim.psid, function(d) est_qte(Y, treat, covar, data = d))
```

```{r, message=FALSE, warning=FALSE}
qte.nsw.cps <- est_qte(Y, treat, NULL, data = nsw_trim_cps)
qte.nsw.psid <- est_qte(Y, treat, NULL, data = nsw_trim_psid)
qte.nsw_cps.trim <- est_qte(Y, treat, covar, data = nsw_cps_trim_match) 
qte.nsw_psid.trim <- est_qte(Y, treat, covar, data = nsw_psid_trim_match) 
```

```{r, message=FALSE, warning=FALSE}
qte.nsw0 <- est_qte(Y, treat, NULL, data = nsw)
qte.nsw_cps0 <- est_qte(Y, treat, NULL, data = nsw_cps)
qte.nsw_psid0 <- est_qte(Y, treat, NULL, data = nsw_psid)
qte.top5_cps_trim0  <- lapply(top5_datasets.cps,  function(d) est_qte(Y, treat, NULL, data = d))
qte.top5_psid_trim0 <- lapply(top5_datasets.psid, function(d) est_qte(Y, treat, NULL, data = d))
```

```{r, message=FALSE, warning=FALSE}
qte.nsw_cps.trim0 <- est_qte(Y, treat, NULL, data = nsw_cps_trim_match) 
qte.nsw_psid.trim0 <- est_qte(Y, treat, NULL, data = nsw_psid_trim_match) 
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGUREC4. SubfigureB:NSW-CPS-1. SubfigureC:NSW-PSID-1. SubfigureD-H:Top-NSW-CPS-1. SubfigureI-M:Top-NSW-PSID-1. SubfigureN:NSW-CPS-1-PLUS. SubfigureO:NSW-PSID-1-PLUS. QTET Estimates using NSW Data: Experimental vs. Nonexperimental"}
par(mfrow = c(2,2))
par(cex.main = 0.9)
ylim = c(-25000, 15000)

plot_qte(qte.nsw_cps, qte.nsw_cps0, qte.nsw, main = "(B) NSW-CPS-1", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
       lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")

plot_qte(qte.nsw_psid, qte.nsw_psid0, qte.nsw, main = "(C) NSW-PSID-1", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
       lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")

plot_qte_top(qte.top5_cps_trim, qte.top5_cps_trim0, qte.top5_cps, all_plot_titles, main_start = 4)

plot_qte_top(qte.top5_psid_trim, qte.top5_psid_trim0, qte.top5_psid, all_plot_titles, main_start = 9)

plot_qte(qte.nsw_cps.trim, qte.nsw_cps.trim0, qte.nsw.cps, main = "(N) NSW-CPS-1-PLUS (Trimmed)", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
       lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")

plot_qte(qte.nsw_psid.trim, qte.nsw_psid.trim0, qte.nsw.psid, main = "(O) NSW-PSID-1-PLUS (Trimmed)", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
    lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")
```

These figures display QTET estimates derived from both the NSW experimental and various observational samples. 

The QTETs estimated from the NSW-CPS-1 sample (B) corresponds well with the true QTET, although the estimates are often underpowered. The QTET estimates from top-ranked subsamples show clear biases when compared to the experimental benchmark (D, E and G), except for `k3_walker` and `cem_crump` (F and H), where the QTET estimates align reasonably well with the true QTET. 

The QTETs estimated from the NSW-PSID-1 sample (C) show notable biases in contrast to the experimental benchmark. Among its top-ranked subsamples (I-M) the QTET estimates exhibit substantial bias and are highly underpowered, reflecting great estimation uncertainty.

For the trimmed and matched NSW-CPS-1-PLUS sample (N), the QTET estimates align reasonably well with the experimental benchmark, whereas for the trimmed and matched NSW-PSID-1-PLUS sample (O), the QTET estimates shows notable biases.
```{r, message=FALSE, warning=FALSE}
# list results
plots_nsw <- list(
  list(mod = qte.nsw_cps, mod0 = qte.nsw_cps0, bm = qte.nsw, 
       main = "(B) NSW-CPS-1"),
  list(mod = qte.nsw_psid, mod0 = qte.nsw_psid0, bm = qte.nsw, 
       main = "(C) NSW-PSID-1"),
  list(mod = qte.nsw_cps.trim, mod0 = qte.nsw_cps.trim0, bm = qte.nsw.cps, 
       main = "(N) NSW-CPS-1-PLUS (Trimmed)"),
  list(mod = qte.nsw_psid.trim, mod0 = qte.nsw_psid.trim0, bm = qte.nsw.psid, 
       main = "(O) NSW-PSID-1-PLUS (Trimmed)")
)

# save results
save_qtet(plots_nsw, prefix = "nsw")
save_qte_top(qte.top5_cps_trim, qte.top5_cps_trim0, qte.top5_cps, all_plot_titles, main_start = 8, prefix = "nsw_top")
save_qte_top(qte.top5_psid_trim, qte.top5_psid_trim0, qte.top5_psid, all_plot_titles, main_start = 13, prefix = "nsw_top")
```

### Assessing outcome weights (OW)
```{r, message=FALSE, warning=FALSE}
# list all datasets
all_datasets <- c(list(nsw, nsw_cps, nsw_psid), top5_datasets.cps, top5_datasets.psid, list(nsw_cps_trim_match, nsw_psid_trim_match))

# estimate ATT 
res_att <- get_res_att(all_datasets, Y, treat, covar)

# extract outcome weights
ow_att <- derive_ow(res_att)
```

```{r, out.width='100%', fig.asp=1, fig.cap="FIGUREC5. SubfigureA:NSW-Experimental. SubfigureB:NSW-CPS-1. SubfigureC:NSW-PSID-1. SubfigureD-H:Top-NSW-CPS-1. SubfigureI-M:Top-NSW-PSID-1. SubfigureN:NSW-CPS-1-PLUS. SubfigureO:NSW-PSID-1-PLUS. Outcome Weights using NSW Data"}
par(mfrow = c(2,2))
par(cex.main = 0.8)

# plot outcome weights distribution
plot_ow(ow_att, all_plot_titles) 
```

```{r, message=FALSE, warning=FALSE}
# evaluate results
res_ow <- eval_ow(ow_att, all_datasets, all_plot_titles, treat, "AIPW-ATT")

# print table output
datatable(res_ow, caption = "Outcome Weights for Treated and Untreated",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

```{r, message=FALSE, warning=FALSE}
#save results
save_ow(ow_att, all_plot_titles, prefix = "nsw")
save_csv(res_ow, "nsw_ow")
```

Consistent with the preceding sections, the evaluation shows that, across each sample, the estimated outcome weights sum to one within the treated group and to minus one within the untreated group, yielding an overall total of zero. Note, that minor deviations from exact values are attributable to floating-point rounding error in numerical summation.

<div class="callout-tip">
A placebo test is not performed as the NSW data comes from a randomized controlled trial (RCT), which ensures internal validity and unbiased treatment effect estimates, without confounding.
</div>

## Validation through sensitivity analyses
```{r, message=FALSE, warning=FALSE}
# define variables
Y <- "re78"
treat <- "treat"
covar <- c("age", "education", "black", "hispanic", "married", "nodegree", "re75", "u75")
bm <- c("re75")
```

```{r, message=FALSE, warning=FALSE}
# check for valid datasets 
filtered_datasets_sens <- check_filter_datasets(all_datasets, Y, treat, covar, bm)
```

```{r, out.width='100%', fig.asp=1, fig.cap="FIGUREC6. SubfigureA:NSW-Experimental. SubfigureB:NSW-CPS-1. SubfigureC:NSW-PSID-1. SubfigureD-H:Top-NSW-CPS-1. SubfigureI-M:Top-NSW-PSID-1. SubfigureN:NSW-CPS-1-PLUS. SubfigureO:NSW-PSID-1-PLUS. Sensitivity Analyses NSW"}
par(mfrow = c(2,2))
par(cex.main = 0.8)

# loop over valid datasets and assign index
for (i in seq_along(filtered_datasets_sens)) {
    sens_ana(filtered_datasets_sens[[i]], Y, treat, covar, bm, kd = 1:3)
    title(main = all_plot_titles[i])
}
```

```{r, message=FALSE, warning=FALSE}
# save results
save_sensitivity_plots(all_datasets, Y, treat, covar, bm, all_plot_titles, "nsw")
```

The sensitivity analysis shows that for the NSW-Experimental sample, the estimated treatment effects are fairly robust to increasing confounder strength, as indicated by relatively stable values despite up to triple the correlation levels of the confounder. 

For the NSW-CPS-1 (B) and NSW-PSID-1 (C) sample, as well as the top-ranked subsamples (I), (J), (K) and (M) of NSW-PSID-1 the treatment effect estimates are highly sensitive to unmeasured confounding. For the subsample (L) and all top-ranked subsamples of NSW-CPS-1 (D-H) the treatment effect estimates are reasonably sensitive. Whereas, for the NSW-CPS-1-PLUS subsample (N) the estimates are fairly robust to unmeasured confounding. 

## Summary
After reexamining the original LaLonde (NSW) sample, the results confirm that the NSW-Experimental data shows nearly perfect overlap between treated and control groups, while the observational samples (NSW-CPS-1 and NSW-PSID-1) display weak overlap, with many treated units outside the control range. Expanding these samples with experimental controls and applying the exact approach as defined by @imbens2024 improves effect estimates considerably.

These findings reinforce the lessons from previous LDW analyses: even with improved overlap and some gains in covariate balance, achieving consistent and reliable effect estimates with observational data remains difficult. 
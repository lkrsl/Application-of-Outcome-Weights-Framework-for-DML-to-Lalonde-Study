# LaLonde-Calónico-Smith (LCS) Data 
This section (5) examines the LaLonde female samples reconstructed by @calonico_smith_2017, referred to as the LaLonde-Calónico-Smith (LCS) sample (loaded as `lcs` below, similar to @imbens2024). 

For detailed explanations of the analysis steps and notes, please refer to section 2. Here, we only present and explain the LCS–specific results.

## Set up
### Source functions and load data
```{r, message=FALSE, warning=FALSE}
# source functions
source("https://github.com/xuyiqing/lalonde/blob/main/tutorial/functions.R?raw=TRUE")
source("tutorial/functions.R")
```

```{r, message=FALSE, warning=FALSE}
# load data
load("data/lcs.RData")
```

```{r, message=FALSE, warning=FALSE}
# set seed
set.seed(42)
```

### Load and preprocess data 
```{r, message=FALSE, warning=FALSE}
# expc = 0: experimental treated; 
# expc = 1: experimental control; 
# expc = 2: psid control;

lcs_psid$expc <- 0 
lcs_psid[lcs_psid$treat==0, ]$expc <- 2 
lcs_tr <- lcs[lcs$treat==1, ]
lcs_co <- lcs[lcs$treat==0, ]
lcs_co$treat <- 1
lcs_co$expc <- 1
lcs_psid_plus <- rbind.data.frame(lcs_psid, lcs_co)
```

### Inspect data
```{r, message=FALSE, warning=FALSE}
# collect samples in a list
data <- list(lcs = lcs, lcs_psid = lcs_psid, lcs_psid_plus = lcs_psid_plus)

# print and inspect key metrics of each sample
summary_stats <- inspect_data(data)
datatable(summary_stats, caption = "Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

## Model
```{r, message=FALSE, warning=FALSE}
# define variables
Y <- "re79"
treat <- "treat"
# redefine covariates: removing "nchildren75" to be used as placebo outcome
covar <- c("age", "educ", "nodegree", "married", "black", "hisp", 
           "re75", "u75")
```

<div class="callout-note">
In the following analysis, only LCS-PSID-1 data is used as the original LaLonde study and its reconstruction by Calónico and Smith (2017) designate LCS-PSID-1 as the appropriate nonexperimental control group for women, providing a comparable observational dataset that aligns with the experimental sample’s characteristics (@imbens2024). The LCS-Experimental data is only consulted as benchmark, as randomization already ensures adequate overlap.
</div>

### Pre-assessing methods 
#### Overlap
```{r, message=FALSE, warning=FALSE, fig.cap='FIGURED1. SubfigureA:LCS-Experimental. SubfigureB:LCS-PSID-1.',out.width='100%', fig.asp=0.5}
lcs.ps <- assess_overlap(data = lcs, treat = treat, cov = covar, xlim = c(-1.5, 1.5), breaks = 40)
lcs_psid.ps <- assess_overlap(data = lcs_psid, treat = treat, cov = covar, xlim = c(-11, 7), breaks = 40)
```

As anticipated, the LCS-Experimental data exhibit an almost perfect overlap. In contrast, the observational dataset LCS-PSID-1 displays weak overlap. 
```{r, message=FALSE, warning=FALSE, fig.cap='FIGURED1. SubfigureC:LCS-PSID-1-PLUS.', out.width='80%', fig.asp=1, fig.align='center'}
lcs_psid_plus.ps <- assess_overlap(data = lcs_psid_plus, treat = treat, cov = covar, xlim = c(-15, 5))
```

With the expanded sample LCS-PSID-1-PLUS, it is evident that the degree of overlap between treated and control groups has improved, as seen by a greater coverage of the log-odds densities across the treatment groups.
```{r, message=FALSE, warning=FALSE}
# combine results
data_list <- list(lcs, lcs_psid, lcs_psid_plus)
plot_titles <- c("(A) LCS-Experimental","(B) LCS-PSID-1", "(C) LDW-PSID-1-PLUS")

# save results
save_overlap_panels(
  data_list = data_list,
  treat     = treat,
  covar     = covar,
  plot_titles = plot_titles,
  prefix = "lcs_overlap_panels"
)
```

```{r, message=FALSE, warning=FALSE}
# set model formula
model <- as.formula(paste(treat, "~", paste(covar, collapse = " + ")))
```

## Improving overlap
### Single methods
#### Trimming 
#### Propensity score threshold trimming 
```{r, message=FALSE, warning=FALSE}
# apply trimming with a threshold
lcs_psid.ps_trim <- ps_trim(lcs_psid.ps, threshold = 0.9)

# re-estimate propensity scores on trimmed data 
lcs_psid.ps_trim <- ps_estimate(data = lcs_psid.ps_trim, treat = "treat", cov = covar)
```

#### Common range trimming
```{r, message=FALSE, warning=FALSE}
# trim observations outside the common support region of propensity scores
lcs_psid.ps_common  <- common_range_trim(lcs_psid.ps)

# re-estimate propensity scores on trimmed data 
lcs_psid.ps_common <- ps_estimate(data = lcs_psid.ps_common, treat = "treat", cov = covar)
```

#### Crump trimming 
```{r, message=FALSE, warning=FALSE}
# trim observations with propensity scores outside an interval
lcs_psid.ps_crump <- crump_trim(lcs_psid.ps, lower = 0.1, upper = 0.9)

# re-estimate propensity scores on trimmed data 
lcs_psid.ps_crump <- ps_estimate(data = lcs_psid.ps_crump, treat = "treat", cov = covar)
```

#### Stuermer trimming
```{r, message=FALSE, warning=FALSE}
# trim observations based on propensity score quantiles separately for treated and control
lcs_psid.ps_stuermer <- stuermer_trim(lcs_psid.ps, lower_percentile = 0.05, upper_percentile = 0.95)

# re-estimate propensity scores on trimmed data 
lcs_psid.ps_stuermer <- ps_estimate(data = lcs_psid.ps_stuermer, treat = "treat", cov = covar)
```

#### Walker trimming
```{r, message=FALSE, warning=FALSE}
# trim observations based on preference scores that adjust for treatment prevalence using logit transformations
lcs_psid.ps_walker  <- walker_trim(lcs_psid.ps)

# re-estimate propensity scores on trimmed data 
lcs_psid.ps_walker <- ps_estimate(data = lcs_psid.ps_walker, treat = "treat", cov = covar)
```

### Integrated methods
#### Trimming and matching 
##### Extended samples 
(Similar to tutorial by @imbens2024)
```{r, message=FALSE, warning=FALSE}
# apply trimming with threshold 
lcs_psid_trim <- ps_trim(lcs_psid_plus.ps, threshold = 0.9)

# exclude experimental controls
lcs_psid.trim_match <- subset(lcs_psid_trim, expc %in% c(0, 2) & ps_assoverlap)

# re-estimate propensity scores and employ 1:1 matching
lcs_psid.trim_match <- psmatch(data = lcs_psid.trim_match, Y = "re79", treat = "treat", cov = covar)

# trim experimental data
lcs_trim_psid <- subset(lcs_psid_trim, expc %in% c(0, 1))
lcs_trim_psid$treat[which(lcs_trim_psid$expc == 1)] <- 0
```

##### Initial samples
```{r, message=FALSE, warning=FALSE}
# combine trimmed samples
all_trim.psid  <- list(
  ps_threshold = lcs_psid.ps_trim, 
  common_range = lcs_psid.ps_common, 
  stuermer = lcs_psid.ps_stuermer, 
  walker = lcs_psid.ps_walker, 
  crump = lcs_psid.ps_crump)
```

###### Distance matching
1) 1:1 Nearest neighbor matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with k=1, logistic propensity score and replacement
nn_trim_comb.psid <- attach_matchit(model, data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", replace = TRUE)
```

2) k:1 matching (k=2) with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with k=2, logistic propensity score and replacement
k<-2
k2_trim_comb.psid <- attach_matchit(model, data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
```

3) k:1 matching (k=3) with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with k=3, logistic propensity score and replacement
k<-3
k3_trim_comb.psid <- attach_matchit(model, data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
```

4) Caliper matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with a caliper of 0.1 on the logistic propensity score 
caliper_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", caliper = 0.1, replace = TRUE)
```

5) Common support restriction matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with exclusion of units outside common support
cs_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", discard = "both", reestimate = TRUE, replace = TRUE)
```

6) Mahalanobis distance matching (mahvars) with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching using mahalanobis distance
mahvars_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "nearest", distance = "mahalanobis", replace = FALSE)
```

7) Optimal pair matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform optimal pair matching that minimizes total within-pair distance on propensity scores
optimal_pair_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "optimal", distance = "glm", link = "logit")
```

8) Optimal full matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform optimal full matching allowing sets with varying ratios of treated to controls and minimizing a global distance criterion
optimal_full_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "full", distance = "glm", link = "logit")
```

9) Generalized full matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform generalized full matching using fast approximation and producing matched sets with flexible treated/control ratios 
general_full_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "quick", distance = "glm", link = "logit")
```

10) Genetic matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform genetic matching 
genetic_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "genetic", distance = "glm", link = "logit", replace = TRUE, pop.size = 100)
```

###### Stratum matching
11) Exact matching (exact)
```{r, message=FALSE, warning=FALSE}
# match units exactly by raw covariate profiles 
exact_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "exact")
```

12) Coarsened matching (cem)
```{r, message=FALSE, warning=FALSE}
# match units exactly within coarse strata 
cem_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "cem")
```

13) Subclassification 
```{r, message=FALSE, warning=FALSE}
# partition sample into fixed number of bins based on propensity score 
subcl_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "subclass", subclass = 3)
```

###### Pure subset selection
14) Cardinality profile matching
```{r, message=FALSE, warning=FALSE}
# select largest balanced subsample meeting covariate balance tolerances and a fixed ratio of controls to treated units
card_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "cardinality", tols = 0.1, ratio = 1, time = 1200)
```

15) Profile matching
```{r, message=FALSE, warning=FALSE}
# select the largest control group subset balanced to the treated group (for ATT), leaving the treated group intact
profile_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "cardinality", estimand = "ATT", tols = 0.1, ratio = NA, time = 1200)
```

## Post-assessing methods
### Single methods
#### Trimming
##### SMD
```{r, message=FALSE, warning=FALSE}
# compute absolute standardized mean differences
smd_trim.psid <- compute_abs_smd_trim(all_trim.psid, "treat", covar)
```

##### OVL
```{r, message=FALSE, warning=FALSE}
# compute overlap coefficients
ovl_trim.psid <- compute_ovl_trim(all_trim.psid, "ps_assoverlap", "treat")
```

### Integrated methods
#### Trimming and matching
##### Extended samples
(Similar to tutorial by @imbens2024)
```{r, message=FALSE, warning=FALSE}
# list all trimmed and matched samples
trim_match_comb.psid_plus <- list(ps_threshold_match = lcs_psid.trim_match)
```

###### SMD
```{r, message=FALSE, warning=FALSE}
# compute absolute standardized mean differences
smd_trim_match_comb.psid_plus <- compute_abs_smd_trim(trim_match_comb.psid_plus, "treat", covar)
```

###### OVL
```{r, message=FALSE, warning=FALSE}
# compute overlap coefficients
ovl_trim_match_comb.psid_plus <- compute_ovl_trim(trim_match_comb.psid_plus, "ps_assoverlap", "treat")
```

##### Initial samples
```{r, message=FALSE, warning=FALSE}
# list all trimmed and matched samples
trim_match_comb.psid <- list(
  nn = nn_trim_comb.psid,
  k2 = k2_trim_comb.psid, 
  k3 = k3_trim_comb.psid, 
  caliper = caliper_trim_comb.psid, 
  cs = cs_trim_comb.psid,
  mahvars = mahvars_trim_comb.psid,
  optimal_pair = optimal_pair_trim_comb.psid, 
  optimal_full = optimal_full_trim_comb.psid, 
  genetic = genetic_trim_comb.psid,
  exact = exact_trim_comb.psid,
  cem = cem_trim_comb.psid,
  subcl = subcl_trim_comb.psid 
)
```

###### SMD
```{r, message=FALSE, warning=FALSE}
# compute absolute standardized mean differences
smd_trim_match_comb.psid <- compute_abs_smd_matchit(trim_match_comb.psid, all_trim.psid)
```

###### OVL
```{r, message=FALSE, warning=FALSE}
# compute overlap coefficients
ovl_trim_match_comb.psid <- compute_ovl_matchit(trim_match_comb.psid, all_trim.psid, ps = "ps_assoverlap", treat = "treat", covar = covar)
```

## Identifying most efficient methods
### Ranking
```{r, message=FALSE, warning=FALSE}
# combine all results
all_psid <- combine_results("psid") 
```

```{r, message=FALSE, warning=FALSE}
# save results
save_csv(all_psid, "lcs_psid1_all_results")
```

```{r, message=FALSE, warning=FALSE}
# rank comparatively
ranked_psid <- assess_methods(all_psid)

# get top 5 methods
top5_methods.psid <- get_top_methods(ranked_psid, top_n = 5)

# rerank top 5 methods
top5_methods_df.psid <- ranked_psid %>% arrange(desc(OVL)) %>% head(5) %>% arrange(Mean_Abs_SMD)

# get results
top5_methods.psid <- top5_methods_df.psid$Method

# print table output
datatable(top5_methods_df.psid, caption = "Top 5 Methods for PSID-1", options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(top5_methods.psid, "lcs_psid1_top5_methods")
```

### Sample construction
```{r, message=FALSE, warning=FALSE}
# create lookup lists
trim_only_psid <- list(
        ps_threshold = lcs_psid.ps_trim,
        common_range = lcs_psid.ps_common,
        stuermer = lcs_psid.ps_stuermer,
        walker = lcs_psid.ps_walker,
        crump = lcs_psid.ps_crump
)

match_lookup_psid <- c(
        wrap_match_entries(nn_trim_comb.psid, all_trim.psid, "nn"),
        wrap_match_entries(k2_trim_comb.psid, all_trim.psid, "k2"),
        wrap_match_entries(k3_trim_comb.psid, all_trim.psid, "k3"),
        wrap_match_entries(caliper_trim_comb.psid, all_trim.psid, "caliper"),
        wrap_match_entries(cs_trim_comb.psid, all_trim.psid, "cs"),
        wrap_match_entries(mahvars_trim_comb.psid, all_trim.psid, "mahvars"),
        wrap_match_entries(optimal_pair_trim_comb.psid, all_trim.psid, "optimal_pair"),
        wrap_match_entries(optimal_full_trim_comb.psid, all_trim.psid, "optimal_full"),
        wrap_match_entries(genetic_trim_comb.psid, all_trim.psid, "genetic"),
        wrap_match_entries(exact_trim_comb.psid, all_trim.psid, "exact"),
        wrap_match_entries(cem_trim_comb.psid, all_trim.psid, "cem"),
        wrap_match_entries(subcl_trim_comb.psid, all_trim.psid, "subcl")
)

list_psid <- c(trim_only_psid, match_lookup_psid)
```

```{r, message=FALSE, warning=FALSE}
# create samples corresponding to the top 5 methods for each sample
top5_datasets.psid <- create_top5_datasets(list_psid, top5_methods.psid)

# extract top5 objects 
top5_objects.psid <- lapply(top5_methods.psid, function(m) list_psid[[m]])
```

```{r, message=FALSE, warning=FALSE}
# save samples into .RData files
save_top5_datasets(list_psid, top5_methods.psid, prefix = "lcs_psid1")
```

## Estimating
### Average treatment effect on the treated (ATT)
```{r, message=FALSE, warning=FALSE}
# get estimates
out1 <- estimate_all(lcs, "re79", "treat", covar)
out2 <- estimate_all(lcs_psid, "re79", "treat", covar)

out.psid <- lapply(top5_datasets.psid, function(d) estimate_all(d, "re79", "treat", covar))
out.psid_trim <- lapply(all_trim.psid, function(d) estimate_all(d, "re79", "treat", covar))

load("data/lcs.RData")
out3 <- estimate_all(lcs_trim_psid, Y, "treat", covar)
out4 <- estimate_all(lcs_psid_trim, Y, "treat", covar)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGURED2. SubfigureA:LCS-Experimental. SubfigureB:LCS-PSID-1. SubfigureC-G:Top-LCS-PSID-1. SubfigureH:LCS-PSID-1-PLUS. ATT Estimates Given Unconfoundedness using LCS Samples"}
par(mfrow = c(4, 1), mar = c(4, 4, 2, 1))

# experimental benchmarks
band.exp <- out1[1, 3:4]
est.exp  <- out1[1, 1]

# plot results
plot_coef(out1,  band = band.exp, line = est.exp, 
          ylim = c(-15500, 5500), main = "(A) LCS-Experimental")

plot_coef(out2,  band = band.exp, line = est.exp, 
          ylim = c(-15500, 5500), main = "(B) LCS-PSID-1")

# get nonexperimtenal benchmarks
method_names_psid <- sapply(top5_methods.psid, function(m) {
    matches <- names(out.psid_trim)[sapply(names(out.psid_trim), function(n) grepl(n, m, fixed=TRUE))]
    if (length(matches) > 0) matches[which.max(nchar(matches))] else NA 
})

band.psid <- lapply(method_names_psid, function(j) out.psid_trim[[j]][1, 3:4])
est.psid  <- lapply(method_names_psid, function(j) out.psid_trim[[j]][1, 1])

# plot results
for (i in seq_along(out.psid)) {
  this_title <- paste0("(", LETTERS[i+2], ") Top PSID-1: ", top5_methods.psid[i])
  plot_coef(out.psid[[i]], band = band.psid[[i]], line = est.psid[[i]],
            ylim = c(-15500, 5500), main = this_title)
}

# nonexperimtenal benchmarks
band.psid_plus <- out3[1, 3:4]
est.psid_plus <- out3[1, 1]

# plot results
plot_coef(out4, band = band.psid_plus, line = est.psid_plus, 
          ylim = c(-15500, 5500), main = "(H) Trimmed LCS-PSID-1-PLUS")
```

```{r, message=FALSE, warning=FALSE}
# get all outputs
all_outs <- c(list(out1, out2), out.psid, list(out4))

# get plot titles
all_plot_titles <- c("(A) LCS-Experimental", "(B) LCS-PSID-1",
                      paste0("(", LETTERS[3:7], ") Top PSID-1: ", top5_methods.psid),
                      "(H) Trimmed LCS-PSID-1-PLUS")

# get confidence interval bounds
all_bands <- c(list(band.exp, band.exp), band.psid, list(band.psid_plus))

all_ests <- c(list(est.exp, est.exp), est.psid, list(est.psid_plus))

# save results
save_att_panels(
    out_list    = all_outs,
    plot_titles = all_plot_titles,
    band_list   = all_bands,
    est_list    = all_ests,
    prefix      = "lcs_est_comb"
)
```

The above figures show the ATT estimates and their 95% confidence intervals for eight samples: LCS-Experimental, LCS-PSID-1, a series of top-ranked subsamples of LCS-PSID-1 based on various trimming or integrated criteria, as well as a trimmed and matched version of the LCS-PSID-1-PLUS sample (analogous to @imbens2024).

Figure (A) presents the experimental sample (LCS-Experimental), serving as a reference for bias and variance assessment of observational samples. Figures (B) shows results for the observational sample LCS-PSID-1 and figures (C) through (G) display results for LCS-PSID-1-based top-ranked subsamples. Figure (H) shows results for a trimmed and matched version of LCS-PSID-1-PLUS, replicating the tutorial results of Imbens & Xu (2024). 

Across the LCS-PSID-1 dataset and its top-ranked subsamples, all estimators yield ATT estimates that largely cluster around the experimental benchmark except for `genetric_walker` and `exact_common_range`, which tend to produce estimates that deviate slightly more from the respective benchmarks.
```{r, message=FALSE, warning=FALSE}
# evaluate results
all_summaries <- lapply(all_outs, eval_att)
att_summary <- do.call(rbind, all_summaries)
rownames(att_summary) <- all_plot_titles

# print table output
datatable(att_summary, caption = "ATT Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

The ATT results are presented in the table below.
```{r, message=FALSE, warning=FALSE}
# create result matrix
out.psid_top <- lapply(method_names_psid, function(j) out.psid_trim[[j]])
all_out_mat <- c(list(out1), out.psid_top, list(out4))
result_mat <- create_matrix_results(all_outs, all_out_mat, all_plot_titles)

# print table output
datatable(result_mat, caption = "ATT Estimates and SEs",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

The tabulated results confirm visual patterns: Column (A) reports the estimates for the LCS-Experimental sample, column (B) for the LCS-PSID-1 sample, columns (D)-(H) for the top-ranked subsample of LCS-PSID-1, and column (C) for its trimmed and matched version of LCS-PSID-1-PLUS.

For all LCS-PSID-1-based samples, the ATT estimates remain overly positive. However, the ATT estimates obtained with the `diff` and `psm` estimators are in at least one case negative.
```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(result_mat, "lcs_att_est")
```

### Conditional average treatment effect on the treated (CATT)
```{r, warning=FALSE, message=FALSE}
catt.lcs <- catt(lcs, Y, treat, covar)
catt.psid <- catt(lcs_psid, Y, treat, covar)
catt.top5_psid <- lapply(top5_datasets.psid, function(d) catt(d, Y, treat, covar))
catt.top5_psid_trim <- lapply(all_trim.psid, function(d) catt(d, Y, treat, covar))
```

```{r, warning=FALSE, message=FALSE}
catt.lcs.psid <- catt(lcs_trim_psid, Y, treat, covar)
catt.psid.trim <- catt(lcs_psid_trim, Y, treat, covar)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGURED3. SubfigureB:LCS-PSID-1. SubfigureC-G:Top-LCS-PSID-1. SubfigureH:LCS-PSID-1-PLUS. CATT Estimates using LCS Data: Experimental vs. Nonexperimental"}
# plot results
par(mfrow = c(2,2)) 
par(cex.main = 0.9)

plot_catt(
  catt1 = catt.lcs$catt,
  catt2 = catt.psid$catt,
  att1  = catt.lcs$att[1],
  att2  = catt.psid$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (CPS-1)",
  main  = "(B) LCS-PSID-1", 
  axes.range = c(-8000, 8000)
)

plot_catt_panels(
  exp_catt = catt.top5_psid_trim,
  catt_list  = catt.top5_psid,
  plot_titles = paste0("(", LETTERS[3:7], ") Top PSID-1: ", top5_methods.psid)
)

plot_catt(
  catt1 <- catt.lcs.psid$catt,
  catt2 <- catt.psid.trim$catt,
  att1 <- catt.lcs.psid$att[1],
  att2 <- catt.psid.trim$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (PSID-1-PLUS-Trimmed)",
  main  = "(H) Trimmed LCS-PSID-1-PLUS",
  axes.range = c(-8000, 8000)
)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1.}
# combine all catt  
all_catt <- c(list(catt.lcs, catt.psid), catt.top5_psid, list(catt.psid.trim))

# evaluate catt 
all_catt_eval <- eval_catt(all_catt, all_plot_titles)

# print table output
datatable(all_catt_eval, caption = "CATT Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

With LCS-PSID-1, CATT estimates span from $-3,149.81 to $2,395.66, contrasting with the CATT estimated from experimental data which ranges from $-478.45 to $2,895.23, with a mean CATT estimate of $886.31. 

In contract, across the LCS-PSID-1-based subsamples, the ranges of CATT estimates are considerably large. Importantly, the mean CATT estimates remain positive in all cases and for the `optimal_pair_stuermer` subsample as well as the trimmed and matched version of LCS-PSID-1-PLUS the mean CATT values are notably reduced.
```{r, message=FALSE, warning=FALSE}
# save results
save_main_catt_panels(
  catt_refs = list(catt.lcs),
  catt_comps = list(catt.psid),
  ylabels = c("CATT (PSID1)"),
  prefix = "lcs_catt_main_panels",
  main_titles = c("(B) LCS-PSID-1")
)

save_catt_panels(
  exp_catt = catt.top5_psid_trim,
  catt_list  = catt.top5_psid,
  plot_titles = paste0("(", LETTERS[3:7], ") Top PSID-1: ", top5_methods.psid),
  prefix = "lcs_catt_top5_psid"
)

save_plus_catt_panels(
  catt1_list = list(catt.lcs.psid),
  catt2_list = list(catt.psid.trim),
  ylabels = c("CATT (PSID-1-PLUS-Trimmed)"),
  prefix = "lcs_catt_plus_panels",
  main_titles = c("(H) Trimmed LCS-PSID-1-PLUS")
)
```

### Quantile treatment effect on the treated (QTET)
```{r, message=FALSE, warning=FALSE}
qte.lcs <- est_qte(Y, treat, covar, data = lcs, cores = 4)
qte.lcs_psid <- est_qte(Y, treat, covar, data = lcs_psid)
qte.top5_psid <- lapply(top5_datasets.psid, function(d) est_qte(Y, treat, covar, data = d))
qte.top5_psid_trim <- lapply(all_trim.psid, function(d) est_qte(Y, treat, covar, data = d))
```

```{r, message=FALSE, warning=FALSE}
qte.lcs.psid <- est_qte(Y, treat, NULL, data = lcs_trim_psid)
qte.lcs_psid.trim <- est_qte(Y, treat, covar, data = lcs_psid_trim)
```

```{r, message=FALSE, warning=FALSE}
qte.lcs0 <- est_qte(Y, treat, NULL, data = lcs)
qte.lcs_psid0 <- est_qte(Y, treat, NULL, data = lcs_psid)
qte.top5_psid_trim0 <- lapply(top5_datasets.psid, function(d) est_qte(Y, treat, NULL, data = d))
```

```{r, message=FALSE, warning=FALSE}
qte.lcs_psid.trim0 <- est_qte(Y, treat, NULL, data = lcs_psid_trim)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGURED4. SubfigureB:LCS-PSID-1.  SubfigureC-G:Top-LCS-PSID-1. SubfigureH:LCS-PSID-1-PLUS. QTET Estimates using LCS Data: Experimental vs. Nonexperimental"}
par(mfrow = c(2,2))
par(cex.main = 0.9)
ylim = c(-25000, 15000)

plot_qte(qte.lcs_psid, qte.lcs_psid0, qte.lcs, main = "(B) LCS-PSID-1", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
       lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")

plot_qte_top(qte.top5_psid_trim, qte.top5_psid_trim0, qte.top5_psid, all_plot_titles, main_start = 3)

plot_qte(qte.lcs_psid.trim, qte.lcs_psid.trim0, qte.lcs.psid, main = "(H) Trimmed LCS-PSID-1-PLUS", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
    lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")
```

These figures display QTET estimates derived from both the LCS experimental and various observational samples. The QTETs estimated from both the original and expanded LCS-PSID1-PLUS samples (B and H), as well as from the top-ranked subsamples (C through G), align comparatively close with the true QTET. However, the QTETs from subsample (D) and (G) exhibit stronger bias, suggesting greater estimation uncertainty.
```{r, message=FALSE, warning=FALSE}
# list results
plots_lcs <- list(list(mod = qte.lcs_psid, mod0 = qte.lcs_psid0, bm = qte.lcs, main = "(B) LCS-PSID-1"),
                  list(mod = qte.lcs_psid.trim, mod0 = qte.lcs_psid.trim0, bm = qte.lcs.psid, main = "(H) Trimmed LCS-PSID-1-PLUS"))

# save results
save_qtet(plots_lcs, prefix = "lcs")
save_qte_top(qte.top5_psid_trim, qte.top5_psid_trim0, qte.top5_psid, all_plot_titles, main_start = 3, prefix = "lcs_top")
```

### Assessing outcome weights (OW)
```{r, warning=FALSE, message=FALSE}
# list all datasets
all_datasets <- c(list(lcs, lcs_psid), top5_datasets.psid, list(lcs_trim_psid))

# estimate ATT 
res_att <- get_res_att(all_datasets, Y, treat, covar)

# extract outcome weights
ow_att <- derive_ow(res_att)
```

```{r,  message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGURED5. SubfigureA:LCS-Experimental. SubfigureB:LCS-PSID-1. SubfigureC-G:Top-LCS-PSID-1. SubfigureH:LCS-PSID-1-PLUS. Outcome Weights using LCS Data"}
par(mfrow = c(2,2))
par(cex.main = 0.9)

# plot outcome weights distribution
plot_ow(ow_att, all_plot_titles) 
```

```{r, warning=FALSE, message=FALSE}
# evaluate results
res_ow <- eval_ow(ow_att, all_datasets, all_plot_titles, treat, "AIPW-ATT")

# print table output
datatable(res_ow, caption = "Outcome Weights for Treated and Untreated",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

Consistent with the preceding sections, the evaluation shows that, across each sample, the estimated outcome weights sum to one within the treated group and to minus one within the untreated group, yielding an overall total of zero. Note, that minor deviations from exact values are attributable to floating-point rounding error in numerical summation.
```{r, message=FALSE, warning=FALSE}
# save results
save_ow(ow_att, all_plot_titles, prefix = "lcs")
save_csv(res_ow, "lcs_ow")
```

## Validation through placebo analyses
```{r, warning=FALSE, message=FALSE}
# define variables
Y <- "nchildren75"
treat <- "treat"
covar <- c("age", "educ", "nodegree", "married", "black", "hisp", "re75", "u75")
```

```{r, warning=FALSE, message=FALSE}
# estimate placebo ATT on original and observational samples
out1_pl <- estimate_all(lcs, Y, "treat", covar)
out2_pl <- estimate_all(lcs_psid, Y, "treat", covar)
```

```{r, message=FALSE, warning=FALSE}
# estimate placebo ATT on top ranked samples
out.psid_pl <- lapply(top5_datasets.psid, function(d) estimate_all(d, Y, "treat", covar))
out.psid_trim_pl <- lapply(all_trim.psid, function(d) estimate_all(d, Y, "treat", covar))
```

```{r, warning=FALSE, message=FALSE}
# estimate placebo ATT on plus samples
load("data/trimmed.RData")
out3_pl <- estimate_all(lcs_trim_psid, Y, "treat", covar)
out4_pl <- estimate_all(lcs_psid_trim, Y, "treat", covar)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGURED6. SubfigureA:LCS-Experimental. SubfigureB:LCS-PSID-1. SubfigureC-G:Top-LCS-PSID-1. SubfigureH:LCS-PSID-1-PLUS. Placebo Test: Number of Children in 1975 as the Outcome"}
par(mfrow = c(4, 1), mar = c(4, 4, 2, 1))

# experimental benchmarks
band.exp_pl <- out1_pl[1, 3:4]
est.exp_pl <- out1_pl[1, 1]

# plot placebo results
plot_coef(out1_pl,  band = band.exp_pl, line = est.exp_pl, 
          ylim = c(-1.5, 1), main = "(A) LCS-Experimental")

plot_coef(out2_pl,  band = band.exp_pl, line = est.exp_pl,
          ylim = c(-1.5, 1), main = "(B) LCS-PSID-1")

# get nonexperimtenal benchmarks
method_names_psid <- sapply(top5_methods.psid, function(m) {
    matches <- names(out.psid_trim_pl)[sapply(names(out.psid_trim_pl), function(n) grepl(n, m, fixed=TRUE))]
    if (length(matches) > 0) matches[which.max(nchar(matches))] else NA 
})

band.psid_pl <- lapply(method_names_psid, function(j) {as.numeric(out.psid_trim_pl[[j]][1, 3:4])})
est.psid_pl  <- lapply(method_names_psid, function(j) out.psid_trim_pl[[j]][1, 1])

# plot placebo results
for (i in seq_along(out.psid_pl)) {
  this_title <- paste0("(", LETTERS[i+2], ") Top PSID1: ", top5_methods.psid[i])
  plot_coef(out.psid_pl[[i]], band = band.psid_pl[[i]], line = est.psid_pl[[i]],
            ylim = c(-1.5, 1), main = this_title)
}

# nonexperimtenal benchmarks
band.psid_plus_pl <- out3_pl[1, 3:4]
est.psid_plus_pl <- out3_pl[1, 1]

# plot placebo results
plot_coef(out4_pl, band = band.psid_plus_pl, line = est.psid_plus_pl, 
          ylim = c(-1.5, 1), main = "(H) Trimmed LCS-PSID-1-PLUS")
```

```{r, message=FALSE, warning=FALSE}
# combine results
all_outs_pl <- c(list(out1_pl, out2_pl), out.psid_pl, list(out4_pl))
all_bands_pl <- c(list(band.exp_pl, band.exp_pl), band.psid_pl, list(band.psid_plus_pl))
all_ests_pl <- c(list(est.exp_pl, est.exp_pl), est.psid_pl, list(est.psid_plus_pl))

# save results
save_att_panels(
    out_list    = all_outs_pl,
    plot_titles = all_plot_titles,
    band_list   = all_bands_pl,
    est_list    = all_ests_pl,
    prefix      = "lcs_pl_est_comb"
)
```

```{r, message=FALSE, warning=FALSE}
# create result matrix
all_outs_pl <- c(list(out1_pl, out2_pl), out.psid_pl, list(out4_pl))
out.psid_top_pl <- lapply(method_names_psid, function(j) out.psid_trim_pl[[j]])
all_out_mat_pl <- c(list(out1_pl), out.psid_top_pl, list(out4_pl))
result_mat_pl <- create_matrix_results(all_outs_pl, all_out_mat_pl, all_plot_titles)

# print table output
datatable(result_mat_pl, caption = "Placebo ATT Estimates and SEs",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

The placebo analysis shows that the experimental benchmark is close to zero and statistically insignificant, while all estimators applied to the observational datasets produce large negative estimates, remaining statistically different from zero, stressing the persistent challenges in adjusting for confounding using observational data.
```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(result_mat_pl, "lcs_att_estimates_pl")
```

## Validation through sensitivity analyses
```{r, warning=FALSE, message=FALSE}
# define variables
Y <- "re79"
treat <- "treat"
# redefine covariates
covar <- c("age", "educ", "nodegree", "married", "black", "hisp", "re75", "u75")
bm <- c("re75")
```

```{r, warning=FALSE, message=FALSE}
# check for valid datasets 
filtered_datasets_sens <- check_filter_datasets(all_datasets, Y, treat, covar, bm)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGURED7. SubfigureA:LCS-Experimental. SubfigureB:LCS-PSID-1. SubfigureC-G:Top-LCS-PSID-1. SubfigureH:LCS-PSID-1-PLUS. Sensitivity Analyses LCS"}
par(mfrow = c(2,2))
par(cex.main = 0.8)

# loop over valid datasets and assign index
for (i in seq_along(filtered_datasets_sens)) {
    sens_ana(filtered_datasets_sens[[i]], Y, treat, covar, bm, kd = 1:3)
    title(main = all_plot_titles[i])
}
```

```{r, message=FALSE, warning=FALSE}
# save results
save_sensitivity_plots(filtered_datasets_sens, Y, treat, covar, bm, all_plot_titles, "lcs")
```

The sensitivity analysis shows that treatment effect estimates in LCS-Experimental (A) are robust to unmeasured confounding, as expected. The treatment effect estimates in the observational sample LCS-PSID-1 (B) instead are reasonable sensitive, whereas the top-ranked LCS-PSID-1 subsamples (C), (E) and (F) as well as the trimmed and matched version of LCS-PSID-1-PLUS (H) produce treatment effects that are rather robust to increasing confounder strength, despite up to triple the correlation levels of the confounder with the treatment and outcome. 

## Summary
After reexamining the LaLonde-Calónico-Smith (LCS) data, the results confirm that, as with the NSW and LDW samples, overlap between treated and control groups is generally greater in the experimental sample than in the observational (LCS-PSID-1) sample. Augmenting the sample with experimental controls generally improves overlap.

The findings for the LCS sample closely mirror those from the LDW and NSW analyses: while certain methods can bring effect estimates closer to benchmarks, estimator-dependent variability and sensitivity to sample construction persist. Placebo and sensitivity analyses again show that unconfoundedness is difficult to verify, and that treatment effect estimates from observational data remain fragile. However, the trimming and integrated methods applied here improve both placebo and sensitivity analysis results compared to the initial LCS-PSID-1 sample, indicating an improvement in robustness. Overall, the challenge of obtaining reliable causal estimates for the LCS data persists.
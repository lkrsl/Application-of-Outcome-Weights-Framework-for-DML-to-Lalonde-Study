# LaLonde-Dehejia-Wahba (LDW) Data
This section (3) covers model B, which, similar to model A, uses 1978 earnings (`re78`) as the outcome variable but adjusts for a slightly different set of covariates: age, education, race indicators (`black`, `hispanic`), marital status (`married`), high school dropouts (`nodegree`), 1975 earnings (`re75`), and unemployment status in 1974 and 1975 (`u74`, `u75`), explicitly excluding 1974 earnings (`re74`) to identify potential multicollinearity or confounding. The model is specified via a regression formula based on these covariates. To enhance covariate balance between treated and untreated groups, the same comprehensive suite of methods is employed as in model A, organized into two categories. From these approaches, the top five methods are selected based on a the overlapping coefficient (OVL) and reranked by the mean absolute standardized mean difference (ASMD), and their resulting samples are used to inform subsequent analysis.  Notably, the estimation of the average treatment effect on the treated (ATT) incorporates also incorporates the augmented inverse probability weighting (AIPW) estimator from the `OutcomeWeights` R package. Subsequently, alternative estimands are considered, including the conditional average treatment effect for the treated (CATT) and the quantile treatment effect on the treated (QTET). After estimating these effects, outcome weights are analyzed to identify patterns in the contribution of individual observations to the ATT. Placebo tests are then conducted using 1975 earnings (`re75`) as the outcome variable to assess potential biases and the validity of the unconfoundedness assumption. Finally, sensitivity analyses are performed to evaluate the robustness of the treatment effect estimates to violations of these assumptions.

For detailed explanations of the analysis steps and tips, please refer to section 2. Here, we only explain the model Bâ€“specific results.

## Set up
### Source functions and load data
```{r, message=FALSE, warning=FALSE}
# source functions
source("https://github.com/xuyiqing/lalonde/blob/main/tutorial/functions.R?raw=TRUE")
source("tutorial/functions.R")
```

```{r, message=FALSE, warning=FALSE}
# load data
load("data/lalonde.RData")
```

```{r, message=FALSE, warning=FALSE}
# set seed
set.seed(42)
```

### Inspect data
```{r, message=FALSE, warning=FALSE}
# collect samples in a list
data <- list(ldw = ldw, ldw_tr = ldw_tr, ldw_co = ldw_co, ldw_cps = ldw_cps, ldw_psid = ldw_psid)

# print and inspect key metrics of each sample
summary_stats <- inspect_data(data)
datatable(summary_stats, caption = "Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

### Load and preprocess data 
```{r, message=FALSE, warning=FALSE}
# assigns 1 to the experimental controls
ldw_co$treat <- 1

# merge experimental data with CPS-1 data
ldw_cps_plus <- rbind.data.frame(
  ldw_co,    # experimental controls (260 observations)
  ldw_cps    # CPS-1 data (16177 observations)
)

# merge experimental data with PSID-1 data
ldw_psid_plus <- rbind.data.frame(
  ldw_co,    # experimental controls (260 observations)
  ldw_psid   # PSID-1 data (2675 observations)
)

datasets <- list(ldw_cps_plus  = ldw_cps_plus, ldw_psid_plus = ldw_psid_plus)

# inspect each sample
summary_stats_plus <- inspect_data(datasets)
datatable(summary_stats_plus, caption = "Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

## Model B
```{r, message=FALSE, warning=FALSE}
# define variables
Y <- "re78" 
treat <- "treat" 
covar <- c("age", "education", "black", "hispanic", "married", 
           "nodegree", "re75", "u74", "u75") #re74 excluded
```

### Pre-assessing methods 
#### Overlap
```{r, fig.cap='FIGUREB1. SubfigureA:LDW. SubfigureB:LDW-CPS-1. SubfigureC:LDW-PSID-1.',out.width='100%', fig.asp=0.5}
ldw.ps <- assess_overlap(data = ldw, treat = treat, cov = covar)
ldw_cps.ps <- assess_overlap(data = ldw_cps, treat = treat, cov = covar) 
ldw_psid.ps <- assess_overlap(data = ldw_psid, treat = treat, cov = covar) 
```

```{r, fig.cap='FIGUREB1. SubfigureD:LDW-CPS-1-PLUS. SubfigureE:LDW-PSID-1-PLUS.', out.width='80%', fig.asp=1, fig.align='center'}
ldw_cps_plus.ps <- assess_overlap(data = ldw_cps_plus, treat = treat, cov = covar) 
ldw_psid_plus.ps <- assess_overlap(data = ldw_psid_plus, treat = treat, cov = covar)
```

```{r, message=FALSE, warning=FALSE}
# combine results
data_list <- list(ldw, ldw_cps, ldw_psid, ldw_cps_plus, ldw_psid_plus)
plot_titles <- c("(A) LDW-Experimental","(B) LDW-CPS-1", "(C) LDW-PSID-1", "(D) LDW-CPS-1-PLUS", "(E) LDW-PSID-1-PLUS")

# save results
save_overlap_panels(
  data_list = data_list,
  treat     = treat,
  covar     = covar,
  plot_titles = plot_titles,
  prefix = "ldw_overlap_model_b_panels"
)
```
Since we use the same experimental and observational samples as within model A, overlap patterns are essentially unchanged.
```{r, message=FALSE, warning=FALSE}
# set model formula
model <- as.formula(paste(treat, "~", paste(covar, collapse = " + ")))
```

## Improving overlap
### Single methods
#### Trimming 
1) Propensity score threshold trimming 
```{r, message=FALSE, warning=FALSE}
# apply trimming with a threshold 
ldw_cps.ps_trim <- ps_trim(ldw_cps.ps, threshold = 0.9)
ldw_psid.ps_trim <- ps_trim(ldw_psid.ps, threshold = 0.9)

# re-estimate propensity scores on trimmed data 
ldw_cps.ps_trim <- ps_estimate(data = ldw_cps.ps_trim, treat = treat, cov = covar)
ldw_psid.ps_trim <- ps_estimate(data = ldw_psid.ps_trim, treat = treat, cov = covar)
```

2) Common range trimming
```{r, message=FALSE, warning=FALSE}
# trim observations outside the common support region of propensity scores
ldw_cps.ps_common   <- common_range_trim(ldw_cps.ps)
ldw_psid.ps_common  <- common_range_trim(ldw_psid.ps)

# re-estimate propensity scores on trimmed data 
ldw_cps.ps_common <- ps_estimate(data = ldw_cps.ps_common, treat = treat, cov = covar)
ldw_psid.ps_common <- ps_estimate(data = ldw_psid.ps_common, treat = treat, cov = covar)
```

3) Crump trimming 
```{r, message=FALSE, warning=FALSE}
# trim observations with propensity scores outside an interval
ldw_cps.ps_crump  <- crump_trim(ldw_cps.ps, lower = 0.05, upper = 0.95)
ldw_psid.ps_crump <- crump_trim(ldw_psid.ps, lower = 0.05, upper = 0.95)

# re-estimate propensity scores on trimmed data 
ldw_cps.ps_crump <- ps_estimate(data = ldw_cps.ps_crump, treat = treat, cov = covar)
ldw_psid.ps_crump <- ps_estimate(data = ldw_psid.ps_crump, treat = treat, cov = covar)
```

4) Stuermer trimming
```{r, message=FALSE, warning=FALSE}
# trim observations based on propensity score quantiles separately for treated and control
ldw_cps.ps_stuermer  <- stuermer_trim(ldw_cps.ps)
ldw_psid.ps_stuermer <- stuermer_trim(ldw_psid.ps)

# re-estimate propensity scores on trimmed data 
ldw_cps.ps_stuermer <- ps_estimate(data = ldw_cps.ps_stuermer, treat = treat, cov = covar)
ldw_psid.ps_stuermer <- ps_estimate(data = ldw_psid.ps_stuermer, treat = treat, cov = covar)
```

5) Walker trimming
```{r, message=FALSE, warning=FALSE}
# trim observations based on preference scores that adjust for treatment prevalence using logit transformations
ldw_cps.ps_walker  <- walker_trim(ldw_cps.ps)
ldw_psid.ps_walker <- walker_trim(ldw_psid.ps)

# re-estimate propensity scores on trimmed data 
ldw_cps.ps_walker <- ps_estimate(data = ldw_cps.ps_walker, treat = treat, cov = covar)
ldw_psid.ps_walker <- ps_estimate(data = ldw_psid.ps_walker, treat = treat, cov = covar)
```

### Integrated methods
#### Trimming and matching 
##### Extended datasets 
(Similar to tutorial by @imbens2024)
```{r, message=FALSE, warning=FALSE}
ldw_cps_trim <- ps_trim(ldw_cps_plus.ps, threshold = 0.9)
ldw_psid_trim <- ps_trim(ldw_psid_plus.ps, threshold = 0.8)

# excluding the experimental controls
ldw_cps.trim_match <- subset(ldw_cps_trim, sample %in% c(1,3) & ps_assoverlap)
ldw_psid.trim_match <- subset(ldw_psid_trim, sample %in% c(1,4) & ps_assoverlap)

# re-estimate propensity scores and employ 1:1 matching
ldw_cps.trim_match <- psmatch(data = ldw_cps.trim_match, Y = "re78", treat = "treat", cov = covar)
ldw_psid.trim_match <- psmatch(data = ldw_psid.trim_match, Y = "re78", treat = "treat", cov = covar)

# further subset data and re-assign treat variable 
ldw_trim_cps <- subset(ldw_cps_trim, sample %in% c(1,2) & ps_assoverlap <= 0.9)
ldw_trim_cps$treat[which(ldw_trim_cps$sample == 2)] <- 0

ldw_trim_psid <- subset(ldw_psid_trim, sample %in% c(1,2) & ps_assoverlap <= 0.8)
ldw_trim_psid$treat[which(ldw_trim_psid$sample == 2)] <- 0
```

##### Initial datasets
```{r, message=FALSE, warning=FALSE}
# combine trimmed samples
all_trim.cps  <- list(
  ps_threshold = ldw_cps.ps_trim, 
  common_range = ldw_cps.ps_common, 
  stuermer = ldw_cps.ps_stuermer, 
  walker = ldw_cps.ps_walker, 
  crump = ldw_cps.ps_crump)

all_trim.psid  <- list(
  ps_threshold = ldw_psid.ps_trim, 
  common_range = ldw_psid.ps_common, 
  stuermer = ldw_psid.ps_stuermer, 
  walker = ldw_psid.ps_walker, 
  crump = ldw_psid.ps_crump)
```

###### Distance matching
1) 1:1 Nearest neighbor matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with k=1, logistic propensity score and replacement
nn_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", replace = TRUE)
nn_trim_comb.psid <- attach_matchit(model, data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", replace = TRUE)
```

2) k:1 matching (k=2) with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with k=2, logistic propensity score and replacement
k<-2
k2_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
k2_trim_comb.psid <- attach_matchit(model, data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
```

3) k:1 matching (k=3) with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with k=3, logistic propensity score and replacement
k<-3
k3_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
k3_trim_comb.psid <- attach_matchit(model, data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", ratio = k, replace = TRUE)
```

4) Caliper matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with a caliper of 0.1 on the logistic propensity score 
caliper_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", caliper = 0.1, replace = TRUE)
caliper_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", caliper = 0.1, replace = TRUE)
```

5) Common support restriction matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching with exclusion of units outside common support
cs_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "glm", link = "logit", discard = "both", reestimate = TRUE, replace = TRUE)
cs_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "nearest", distance = "glm", link = "logit", discard = "both", reestimate = TRUE, replace = TRUE)
```

6) Mahalanobis distance matching (mahvars) with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform nearest neighbor matching using mahalanobis distance
mahvars_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "nearest", distance = "mahalanobis", replace = FALSE)
mahvars_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "nearest", distance = "mahalanobis", replace = FALSE)
```

7) Optimal pair matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform optimal pair matching that minimizes total within-pair distance on propensity scores
optimal_pair_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "optimal", distance = "glm", link = "logit")
optimal_pair_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "optimal", distance = "glm", link = "logit")
```

8) Optimal full matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform optimal full matching allowing sets with varying ratios of treated to controls and minimizing a global distance criterion
optimal_full_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "full", distance = "glm", link = "logit")
optimal_full_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "full", distance = "glm", link = "logit")
```

9) Generalized full matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform generalized full matching using fast approximation and producing matched sets with flexible treated/control ratios 
general_full_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "quick", distance = "glm", link = "logit")
general_full_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "quick", distance = "glm", link = "logit")
```

10) Genetic matching with 1) propensity threshold 2) common range 3) stuermer 4) walker 5) crump trimming
```{r, message=FALSE, warning=FALSE}
# perform genetic matching 
genetic_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "genetic", distance = "glm", link = "logit", replace = TRUE, pop.size = 100)
genetic_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "genetic", distance = "glm", link = "logit", replace = TRUE, pop.size = 100)
```

###### Stratum matching
11) Exact matching (exact)
```{r, message=FALSE, warning=FALSE}
# match units exactly by raw covariate profiles 
exact_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "exact")
exact_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "exact")
```

12) Coarsened matching (cem)
```{r, message=FALSE, warning=FALSE}
# match units exactly within coarse strata 
cem_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "cem")
cem_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "cem")
```

13) Subclassification 
```{r, message=FALSE, warning=FALSE}
# partition sample into fixed number of bins based on propensity score 
subcl_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "subclass", subclass = 3)
subcl_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "subclass", subclass = 3)
```

###### Pure subset selection
14) Cardinality profile matching
```{r, message=FALSE, warning=FALSE}
# select largest balanced subsample meeting covariate balance tolerances and a fixed ratio of controls to treated units
card_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "cardinality", tols = 0.1, ratio = 1, time = 1200)
card_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "cardinality", tols = 0.1, ratio = 1, time = 1200)
```

15) Profile matching
```{r, message=FALSE, warning=FALSE}
# select the largest control group subset balanced to the treated group (for ATT), leaving the treated group intact
profile_trim_comb.cps <- attach_matchit(model, data_list = all_trim.cps, method = "cardinality", estimand = "ATT", tols = 0.1, ratio = NA, time = 1200)
profile_trim_comb.psid <- attach_matchit(model,data_list = all_trim.psid, method = "cardinality", estimand = "ATT", tols = 0.1, ratio = NA, time = 1200)
```

## Post-assessing methods
### Single methods
#### Trimming
##### SMD
```{r, message=FALSE, warning=FALSE}
# compute absolute standardized mean differences
smd_trim.cps <- compute_abs_smd_trim(all_trim.cps, "treat", covar)
smd_trim.psid <- compute_abs_smd_trim(all_trim.psid, "treat", covar)
```

##### OVL
```{r, message=FALSE, warning=FALSE}
# compute overlap coefficients
ovl_trim.cps <- compute_ovl_trim(all_trim.cps, "ps_assoverlap", "treat")
ovl_trim.psid <- compute_ovl_trim(all_trim.psid, "ps_assoverlap", "treat")
```

### Integrated methods
#### Trimming and matching
##### Extended samples
(Similar to tutorial by @imbens2024)
```{r, message=FALSE, warning=FALSE}
# list all trimmed and matched samples
trim_match_comb.cps_plus <- list(ps_threshold_match = ldw_cps.trim_match)
trim_match_comb.psid_plus <- list(ps_threshold_match = ldw_psid.trim_match)
```

###### SMD
```{r, message=FALSE, warning=FALSE}
# compute absolute standardized mean differences
smd_trim_match_comb.cps_plus <- compute_abs_smd_trim(trim_match_comb.cps_plus, "treat", covar)
smd_trim_match_comb.psid_plus <- compute_abs_smd_trim(trim_match_comb.psid_plus, "treat", covar)
```

###### OVL
```{r, message=FALSE, warning=FALSE}
# compute overlap coefficients
ovl_trim_match_comb.cps_plus <- compute_ovl_trim(trim_match_comb.cps_plus, "ps_assoverlap", "treat")
ovl_trim_match_comb.psid_plus <- compute_ovl_trim(trim_match_comb.psid_plus, "ps_assoverlap", "treat")
```

##### Initial samples
```{r, message=FALSE, warning=FALSE}
# list all trimmed and matched samples
trim_match_comb.cps <- list(
  nn = nn_trim_comb.cps, 
  k2 = k2_trim_comb.cps,
  k3 = k3_trim_comb.cps, 
  caliper = caliper_trim_comb.cps,
  cs = cs_trim_comb.cps, 
  mahvars = mahvars_trim_comb.cps,
  optimal_pair = optimal_pair_trim_comb.cps,
  optimal_full = optimal_full_trim_comb.cps, 
  genetic = genetic_trim_comb.cps, 
  exact = exact_trim_comb.cps,
  cem = cem_trim_comb.cps,
  subcl = subcl_trim_comb.cps 
)

trim_match_comb.psid <- list(
  nn = nn_trim_comb.psid,
  k2 = k2_trim_comb.psid, 
  k3 = k3_trim_comb.psid, 
  caliper = caliper_trim_comb.psid, 
  cs = cs_trim_comb.psid,
  mahvars = mahvars_trim_comb.psid,
  optimal_pair = optimal_pair_trim_comb.psid, 
  optimal_full = optimal_full_trim_comb.psid, 
  genetic = genetic_trim_comb.psid,
  exact = exact_trim_comb.psid,
  cem = cem_trim_comb.psid,
  subcl = subcl_trim_comb.psid 
)
```

###### SMD
```{r, message=FALSE, warning=FALSE}
# compute absolute standardized mean differences
smd_trim_match_comb.cps <- compute_abs_smd_matchit(trim_match_comb.cps, all_trim.cps) 
smd_trim_match_comb.psid <- compute_abs_smd_matchit(trim_match_comb.psid, all_trim.psid)
```

###### OVL
```{r, message=FALSE, warning=FALSE}
# compute overlap coefficients
ovl_trim_match_comb.cps <- compute_ovl_matchit(trim_match_comb.cps, all_trim.cps, ps = "ps_assoverlap", treat = "treat", covar = covar)
ovl_trim_match_comb.psid <- compute_ovl_matchit(trim_match_comb.psid, all_trim.psid, ps = "ps_assoverlap", treat = "treat", covar = covar)
```

## Identifying most efficient methods
### Ranking
```{r, message=FALSE, warning=FALSE}
# combine all results
all_cps <- combine_results("cps")
all_psid <- combine_results("psid") 
```

```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(all_cps, "ldw_model_a_cps1_all_results")
save_csv(all_psid, "ldw_model_a_psid1_all_results")
```

```{r, message=FALSE, warning=FALSE}
# rank comparatively
ranked_cps  <- assess_methods(all_cps)
ranked_psid <- assess_methods(all_psid)

# get top 5 methods
top5_methods.cps <- get_top_methods(ranked_cps, top_n = 5)
top5_methods.psid <- get_top_methods(ranked_psid, top_n = 5)

# rerank top 5 methods
top5_methods.cps <- rerank_methods(top5_methods.cps, ranked_cps)
top5_methods.psid <- rerank_methods(top5_methods.psid, ranked_psid)
```

```{r, message=FALSE, warning=FALSE}
# print results
top5_methods_df.cps <- ranked_cps %>% arrange(desc(OVL)) %>% head(5) %>% arrange(Mean_Abs_SMD)
top5_methods_df.psid <- ranked_psid %>% arrange(desc(OVL)) %>% head(5) %>% arrange(Mean_Abs_SMD)

datatable(top5_methods_df.cps, caption = "Top 5 Methods for CPS-1", options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
datatable(top5_methods_df.psid, caption = "Top 5 Methods for PSID-1", options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(top5_methods.cps, "ldw_model_b_cps1_top5_methods")
save_csv(top5_methods.psid, "ldw_model_b_psid1_top5_methods")
```

### Sample construction
```{r, message=FALSE, warning=FALSE}
# create lookup lists
match_lookup_cps <- c(
        wrap_match_entries(nn_trim_comb.cps, all_trim.cps, "nn"),
        wrap_match_entries(k2_trim_comb.cps, all_trim.cps, "k2"),
        wrap_match_entries(k3_trim_comb.cps, all_trim.cps, "k3"),
        wrap_match_entries(caliper_trim_comb.cps, all_trim.cps, "caliper"),
        wrap_match_entries(cs_trim_comb.cps, all_trim.cps, "cs"),
        wrap_match_entries(mahvars_trim_comb.cps, all_trim.cps, "mahvars"),
        wrap_match_entries(optimal_pair_trim_comb.cps, all_trim.cps, "optimal_pair"),
        wrap_match_entries(optimal_full_trim_comb.cps, all_trim.cps, "optimal_full"),
        wrap_match_entries(genetic_trim_comb.cps, all_trim.cps, "genetic"),
        wrap_match_entries(exact_trim_comb.cps, all_trim.cps, "exact"),
        wrap_match_entries(cem_trim_comb.cps, all_trim.cps, "cem"),
        wrap_match_entries(subcl_trim_comb.cps, all_trim.cps, "subcl")
)

match_lookup_psid <- c(
        wrap_match_entries(nn_trim_comb.psid, all_trim.psid, "nn"),
        wrap_match_entries(k2_trim_comb.psid, all_trim.psid, "k2"),
        wrap_match_entries(k3_trim_comb.psid, all_trim.psid, "k3"),
        wrap_match_entries(caliper_trim_comb.psid, all_trim.psid, "caliper"),
        wrap_match_entries(cs_trim_comb.psid, all_trim.psid, "cs"),
        wrap_match_entries(mahvars_trim_comb.psid, all_trim.psid, "mahvars"),
        wrap_match_entries(optimal_pair_trim_comb.psid, all_trim.psid, "optimal_pair"),
        wrap_match_entries(optimal_full_trim_comb.psid, all_trim.psid, "optimal_full"),
        wrap_match_entries(genetic_trim_comb.psid, all_trim.psid, "genetic"),
        wrap_match_entries(exact_trim_comb.psid, all_trim.psid, "exact"),
        wrap_match_entries(cem_trim_comb.psid, all_trim.psid, "cem"),
        wrap_match_entries(subcl_trim_comb.psid, all_trim.psid, "subcl")
)

list_cps <- c(all_trim.cps, match_lookup_cps)
list_psid <- c(all_trim.psid, match_lookup_psid)
```

```{r, message=FALSE, warning=FALSE}
# create samples corresponding to the top 5 methods for each sample
top5_datasets.cps <- create_top5_datasets(list_cps, top5_methods.cps)
top5_datasets.psid <- create_top5_datasets(list_psid, top5_methods.psid)

# extract top 5 objects 
top5_objects.cps <- lapply(top5_methods.cps, function(m) list_cps[[m]])
top5_objects.psid <- lapply(top5_methods.psid, function(m) list_psid[[m]])
```

```{r, message=FALSE, warning=FALSE}
# save samples into .RData files
save_top5_datasets(list_cps, top5_methods.cps, prefix = "ldw_model_a_cps1")
save_top5_datasets(list_psid, top5_methods.psid, prefix = "ldw_model_a_psid1")
```

## Estimating
### Average treatment effect on the treated (ATT)
```{r, message=FALSE, warning=FALSE}
# estimate ATT
out1 <- estimate_all(ldw, "re78", "treat", covar)
out2 <- estimate_all(ldw_cps, "re78", "treat", covar)
out3 <- estimate_all(ldw_psid, "re78", "treat", covar)

out.cps <- lapply(top5_datasets.cps, function(d) estimate_all(d, "re78", "treat", covar))
out.psid <- lapply(top5_datasets.psid, function(d) estimate_all(d, "re78", "treat", covar))
out.cps_trim <- lapply(all_trim.cps, function(d) estimate_all(d, "re78", "treat", covar))
out.psid_trim <- lapply(all_trim.psid, function(d) estimate_all(d, "re78", "treat", covar))
```

```{r, message=FALSE, warning=FALSE}
# estimate ATT
load("data/trimmed.RData")
out4 <- estimate_all(ldw_trim_cps, "re78", "treat", covar)
out5 <- estimate_all(ldw_trim_psid, "re78", "treat", covar)
out6 <- estimate_all(ldw_cps_trim, "re78", "treat", covar)
out7 <- estimate_all(ldw_psid_trim, "re78", "treat", covar)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGUREB2. SubfigureA:LDW-Experimental. SubfigureB:LDW-CPS-1. SubfigureC:LDW-PSID-1. SubfigureD-H:Top-LDW-CPS-1. SubfigureI-M:Top-LDW-PSID-1. SubfigureN:LDW-CPS-1-PLUS. SubfigureO:LDW-PSID-1-PLUS. ATT Estimates Model A Given Unconfoundedness using LDW Samples"}
par(mfrow = c(4, 1), mar = c(4, 4, 2, 2))

# experimental benchmarks
band.exp <- out1[1, 3:4]
est.exp  <- out1[1, 1]

# plot results
plot_coef(out1,  band = band.exp, line = est.exp, 
          ylim = c(-15500, 5500), main = "(A) LDW-Experimental")

plot_coef(out2,  band = band.exp, line = est.exp, 
          ylim = c(-15500, 5500), main = "(B) LDW-CPS-1")

plot_coef(out3,  band = band.exp, line = est.exp,
          ylim = c(-15500, 5500), main = "(C) LDW-PSID-1")

# get nonexperimtenal benchmarks
method_names_cps <- sapply(top5_methods.cps, function(m) {
    matches <- names(out.cps_trim)[sapply(names(out.cps_trim), function(n) grepl(n, m, fixed=TRUE))]
    if (length(matches) > 0) matches[which.max(nchar(matches))] else NA })
method_names_psid <- sapply(top5_methods.psid, function(m) {
    matches <- names(out.cps_trim)[sapply(names(out.cps_trim), function(n) grepl(n, m, fixed=TRUE))]
    if (length(matches) > 0) matches[which.max(nchar(matches))] else NA })

band.cps <- lapply(method_names_cps, function(j) out.cps_trim[[j]][1, 3:4])
est.cps  <- lapply(method_names_cps, function(j) out.cps_trim[[j]][1, 1])
band.psid <- lapply(method_names_psid, function(j) out.psid_trim[[j]][1, 3:4])
est.psid  <- lapply(method_names_psid, function(j) out.psid_trim[[j]][1, 1])

# plot results
for (i in seq_along(out.cps)) {
  this_title <- paste0("(", LETTERS[i+3], ") Top CPS-1: ", top5_methods.cps[i])
  plot_coef(out.cps[[i]], band = band.cps[[i]], line = est.cps[[i]],
            ylim = c(-15500, 5500), main = this_title)
}

for (i in seq_along(out.psid)) {
  this_title <- paste0("(", LETTERS[i+8], ") Top PSID-1: ", top5_methods.psid[i])
  plot_coef(out.psid[[i]], band = band.psid[[i]], line = est.psid[[i]],
            ylim = c(-15500, 5500), main = this_title)
}

# get nonexperimtenal benchmarks
band.cps_plus <- out4[1, 3:4]
est.cps_plus <- out4[1, 1]
band.psid_plus <- out5[1, 3:4]
est.psid_plus <- out5[1, 1]

# plot results
plot_coef(out6, band = band.cps_plus, line = est.cps_plus, 
          ylim = c(-15500, 5500), main = "(N) Trimmed LDW-CPS-1-PLUS")

plot_coef(out7, band = band.psid_plus, line = est.psid_plus, 
          ylim = c(-15500, 5500), main = "(O) Trimmed LDW-PSID-1-PLUS")
```

```{r, message=FALSE, warning=FALSE}
# get outputs
all_outs <- c(list(out1, out2, out3), out.cps, out.psid, list(out6, out7))

# get plot titles
all_plot_titles <- c("(A) LDW-Experimental", "(B) LDW-CPS-1", "(C) LDW-PSID-1",
                      paste0("(", LETTERS[4:8], ") Top CPS-1: ", top5_methods.cps),
                      paste0("(", LETTERS[9:13], ") Top PSID-1: ", top5_methods.psid),
                      "(N) Trimmed LDW-CPS-1-PLUS", "(O) Trimmed LDW-PSID-1-PLUS")

# get confidence interval bounds
all_bands <- c(list(band.exp, band.exp, band.exp), band.cps, band.psid, list(band.cps_plus, band.psid_plus))

all_ests <- c(list(est.exp, est.exp, est.exp), est.cps, est.psid, list(est.cps_plus, est.psid_plus))

# save results
save_att_panels(
    out_list    = all_outs,
    plot_titles = all_plot_titles,
    band_list   = all_bands,
    est_list    = all_ests,
    prefix      = "ldw_model_b_est_comb"
)
```

As in model A, the above figures show the ATT estimates and their 95% confidence intervals for fifteen samples: LDW-Experimental, LDW-CPS-1, LDW-PSID-1, trimmed and matched versions of the LDW-CPS-1-PLUS and LDW-PSID-1-PLUS samples (analogous to @imbens2024) and a series of top-ranked subsamples of both LDW-CPS-1 and LDW-PSID-1 based on various trimming and integrated trimming and matching criteria. 

Again, figure (A) presents the benchmark, serving as a reference for bias and variance assessment of observational samples. Figures (B) and (C) show results for the LDW-CPS-1 and LDW-PSID-1, respectively. Figures (D) through (H) display results for LDW-CPS-1-based subsamples constructed with the top-ranked methods. Analogously, figures (I) through (M) summarize results for the corresponding LDW-PSID-1-based subsamples under parallel rules. Figures (N) and (O) present results for the trimmed and matched versions, replicating the tutorial results of Imbens & Xu (2024). 

The LDW-CPS-1 sample produces ATT estimates that closely align with the benchmark with an exception for one estimator similar as in model A. Across its `nn_crump` and `caliper_crump` and `genetic_crump` subsamples all estimators produce ATT estimates that reasonably closely align with the benchmark. Some larger deviations from the benchmark occur for the `genetic_common_range` and `genetic_ps_threshold` subsamples. 

As for LDW-CPS-1, the LDW-PSID-1 sample produces ATT estimates that reasonably closely align with the benchmark with an exception for only one estimator. Across its top-ranked samples, all estimators generally yield ATT estimates that exhibit greater dispersion from the benchmark and considerably larger standard errors. 

Overall, these results show a similar pattern as observed in model A.
```{r, message=FALSE, warning=FALSE}
# evaluate results
all_summaries <- lapply(all_outs, eval_att)
att_summary <- do.call(rbind, all_summaries)
rownames(att_summary) <- all_plot_titles

# print table output
datatable(att_summary, caption = "ATT Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

```{r, message=FALSE, warning=FALSE}
# get result matrix
out.cps_top <- lapply(method_names_cps, function(j) out.cps_trim[[j]])
out.psid_top <- lapply(method_names_psid, function(j) out.psid_trim[[j]])
all_out_mat <- c(list(out1), out.cps_top, out.psid_top, list(out4, out5))
result_mat <- create_matrix_results(all_outs, all_out_mat, all_plot_titles)

# print table output
datatable(result_mat, caption = "ATT Estimates and SEs",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

As in model A, the tabulated results confirm visual patterns: Column (A) reports the estimates for the LDW-Experimental sample, column (B) for the LDW-CPS-1 sample, and column (C) for the LDW-PSID-1 sample. Columns (D)-(O) summarize the top-ranked sample results for both LDW-CPS-1 and LDW-PSID-1. Columns (N) and (O) present estimates for the trimmed and matched versions of the LDW-PSID-1-PLUS and LDW-PSID-1-PLUS samples.

In model B, most LDW-CPS-1-based samples yield ATT estimates that are closer to the experimental benchmark than in model A, with still modest variance. By contrast, the LDW-PSID-1-based estimates, while somewhat closer to the experimental benchmark than in model A, continue to exhibit substantially larger standard errors compared to LDW-CPS-1 samples. This again reflects the greater challenge of obtaining reliable estimates from the observational dataset LDW-PSID-1.

Overall, figures and table jointly demonstrate again that ATT estimates from observational samples tend to have larger standard errors compared to the experimental sample, reflecting greater statistical uncertainty in non-experimental causal effect estimation, and that certain criteria can bring observational estimates closer to the experimental benchmark. Nevertheless, significant estimator-dependent variability and sensitivity to sample construction persist.
```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(result_mat, "ldw_att_est_model_b")
```

### Conditional average treatment effect on the treated (CATT)
```{r, message=FALSE, warning=FALSE}
# estimate CATT
catt.ldw <- catt(ldw, Y, treat, covar)
catt.cps <- catt(ldw_cps, Y, treat, covar)
catt.psid <- catt(ldw_psid, Y, treat, covar)
catt.top5_cps <- lapply(top5_datasets.cps, function(d) catt(d, Y, treat, covar))
catt.top5_psid <- lapply(top5_datasets.psid, function(d) catt(d, Y, treat, covar))
catt.top5_cps_trim <- lapply(all_trim.cps, function(d) catt(d, Y, treat, covar))
catt.top5_psid_trim <- lapply(all_trim.psid, function(d) catt(d, Y, treat, covar))
```

```{r, message=FALSE, warning=FALSE}
# similar to Imbens & Xu (2024) 
catt.trim_cps <- catt(ldw_trim_cps, Y, treat, covar) 
catt.trim_psid <- catt(ldw_trim_psid, Y, treat, covar) 
catt.cps_trim <- catt(ldw_cps_trim, Y, treat, covar)  
catt.psid_trim <- catt(ldw_psid_trim, Y, treat, covar) 
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGUREB3. SubfigureB:LDW-CPS-1. SubfigureC:LDW-PSID-1. SubfigureD-H:Top-LDW-CPS-1. SubfigureI-M:Top-LDW-PSID-1. SubfigureN:LDW-CPS-1-PLUS. SubfigureO:LDW-PSID-1-PLUS. CATT Estimates Model B using LDW Data: Experimental vs. Nonexperimental"}
# plot results
par(mfrow = c(2,2)) 
par(cex.main = 0.9)

plot_catt(
  catt1 = catt.ldw$catt,
  catt2 = catt.cps$catt,
  att1  = catt.ldw$att[1],
  att2  = catt.cps$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (CPS-1)",
  main  = "(B) LDW-CPS-1", 
  axes.range = c(-8000, 8000)
)

plot_catt(
  catt1 = catt.ldw$catt,
  catt2 = catt.psid$catt,
  att1  = catt.ldw$att[1],
  att2  = catt.psid$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (PSID-1)",
  main  = "(C) LDW-PSID-1",
  axes.range = c(-8000, 8000)
)

plot_catt_panels(
  exp_catt = catt.top5_cps_trim,
  catt_list  = catt.top5_cps,
  plot_titles = paste0("(", LETTERS[4:8], ") Top CPS-1: ", top5_methods.cps)
)

plot_catt_panels(
  exp_catt = catt.top5_psid_trim,
  catt_list  = catt.top5_psid,
  plot_titles = paste0("(", LETTERS[9:13], ") Top PSID-1: ", top5_methods.psid)
)

plot_catt(
  catt1 <- catt.trim_cps$catt,
  catt2 <- catt.cps_trim$catt,
  att1 <- catt.trim_cps$att[1],
  att2 <- catt.cps_trim$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (CPS-1-PLUS-Trimmed)",
  main  = "(N) Trimmed LDW-CPS-1-PLUS", 
  axes.range = c(-8000, 8000)
)

plot_catt(
  catt1 <- catt.trim_psid$catt,
  catt2 <- catt.psid_trim$catt,
  att1 <- catt.trim_psid$att[1],
  att2 <- catt.psid_trim$att[1],
  xlab  = "CATT (Experimental)",
  ylab  = "CATT (PSID-1-PLUS-Trimmed)",
  main  = "(O) Trimmed LDW-PSID-1-PLUS",
  axes.range = c(-8000, 8000)
)
```

```{r, out.width='100%', fig.asp=1.}
# combine all catt objects 
all_catt <- c(list(catt.ldw, catt.cps, catt.psid), 
              catt.top5_cps, catt.top5_psid, 
              list(catt.cps_trim, catt.psid_trim))

# evaluate results
all_catt_eval <- eval_catt(all_catt, all_plot_titles)

# print table output
datatable(all_catt_eval, caption = "CATT Summary Statistics",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

In model B, using LDW-CPS-1, CATT estimates range from $-3,316.41 to $7,047.93. This span is considerably narrower than in model A, but still performs worse when contrasted with the experimental benchmark, where CATT estimates range from $-195.61 to $3,809.38 with a mean of $1,744.41. Further, LDW-PSID-1 shows an increased CATT estimate range, from $-7,666.25 to	$4,739.52, and a reasonable lower mean of approximately $433.02 compared to LDW-CPS-1. These patterns mirror those observed in model A.

For LDW-CPS-1 and its top-ranked subsamples, CATT ranges vary considerably, yet their mean estimates are generally closer to the experimental benchmark, as in model A. Moreover, the minimum CATT estimates are less negative, which reduces the spread between minimum and maximum estimates.

The LDW-PSID-1 and its top-ranked subsamples, on the other hand, again yield decreased mean CATT estimates with varying CATT ranges compared to the LDW-CPS-1 sample, signaling persistent difficulties in generating reliable effect estimates. Still, compared to model A, the minimum CATT estimates are less strongly negative, though the mean CATTs do not improve marginally in their proximity to the experimental benchmark.

Hence, alike model A, these results show that there is considerable variation in ranges and means across methods and samples, reflecting substantial heterogeneity in treatment effect estimation. While certain criteria may improve consistency with the benchmark, they may also introduce notable discrepancies and variability in estimated effects. 
```{r, message=FALSE, warning=FALSE}
# save results
save_main_catt_panels(
  catt_refs = list(catt.ldw),
  catt_comps = list(catt.cps, catt.psid),
  ylabels = c("CATT (CPS-1)", "CATT (PSID-1)"),
  prefix = "ldw_model_b_catt_main_panels",
  main_titles = c("(B) LDW-CPS-1", "(C) LDW-PSID-1")
)

save_catt_panels(
  exp_catt = catt.top5_cps_trim,
  catt_list  = catt.top5_cps,
  plot_titles = paste0("(", LETTERS[4:8], ") Top CPS-1: ", top5_methods.cps),
  prefix = "ldw_model_b_catt_top5_cps"
)

save_catt_panels(
  exp_catt = catt.top5_psid_trim,
  catt_list  = catt.top5_psid,
  plot_titles = paste0("(", LETTERS[9:13], ") Top PSID-1: ", top5_methods.psid),
  prefix = "ldw_model_b_catt_top5_psid"
)

save_plus_catt_panels(
  catt1_list = list(catt.trim_cps, catt.trim_psid),
  catt2_list = list(catt.cps_trim, catt.psid_trim),
  ylabels = c("CATT (CPS-1-PLUS-Trimmed)", "CATT (PSID-1-PLUS-Trimmed)"),
  prefix = "ldw_model_b_catt_plus_panels",
  main_titles = c("(N) LDW-CPS-1-PLUS", "(O) LDW-PSID-1-PLUS")
)
```

### Quantile treatment effect on the treated (QTET)
```{r, message=FALSE, warning=FALSE}
qte.ldw <- est_qte(Y, treat, covar, data = ldw, cores = 4)
qte.ldw_cps <- est_qte(Y, treat, covar, data = ldw_cps)
qte.ldw_psid <- est_qte(Y, treat, covar, data = ldw_psid)
qte.top5_cps  <- lapply(top5_datasets.cps,  function(d) est_qte(Y, treat, covar, data = d))
qte.top5_psid <- lapply(top5_datasets.psid, function(d) est_qte(Y, treat, covar, data = d))
qte.top5_cps_trim  <- lapply(all_trim.cps,  function(d) est_qte(Y, treat, covar, data = d))
qte.top5_psid_trim <- lapply(all_trim.psid, function(d) est_qte(Y, treat, covar, data = d))
```

```{r, message=FALSE, warning=FALSE}
qte.trim.ldw_cps <- est_qte(Y, treat, NULL, data = ldw_trim_cps)
qte.trim.ldw_psid <- est_qte(Y, treat, NULL, data = ldw_trim_psid)
qte.ldw_cps.trim <- est_qte(Y, treat, covar, data = ldw_cps_trim) 
qte.ldw_psid.trim <- est_qte(Y, treat, covar, data = ldw_psid_trim) 
```

```{r, message=FALSE, warning=FALSE}
qte.ldw0 <- est_qte(Y, treat, NULL, data = ldw)
qte.ldw_cps0 <- est_qte(Y, treat, NULL, data = ldw_cps)
qte.ldw_psid0 <- est_qte(Y, treat, NULL, data = ldw_psid)
qte.top5_cps_trim0  <- lapply(top5_datasets.cps,  function(d) est_qte_safe(Y, treat, NULL, data = d))
qte.top5_psid_trim0 <- lapply(top5_datasets.psid, function(d) est_qte_safe(Y, treat, NULL, data = d))
```

```{r, message=FALSE, warning=FALSE}
qte.ldw_cps.trim0 <- est_qte(Y, treat, NULL, data = ldw_cps_trim) 
qte.ldw_psid.trim0 <- est_qte(Y, treat, NULL, data = ldw_psid_trim) 
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGUREB4. SubfigureB:LDW-CPS-1. SubfigureC:LDW-PSID-1. SubfigureD-H:Top-LDW-CPS-1. SubfigureI-M:Top-LDW-PSID-1. SubfigureN:LDW-CPS-1-PLUS. SubfigureO:LDW-PSID-1-PLUS. QTET Estimates Model A using LDW Data: Experimental vs. Nonexperimental"}
par(mfrow = c(2,2))
par(cex.main = 0.9)
ylim = c(-25000, 15000)

plot_qte(qte.ldw_cps, qte.ldw_cps0, qte.ldw, main = "(B) LDW-CPS-1", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
       lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")

plot_qte(qte.ldw_psid, qte.ldw_psid0, qte.ldw, main = "(C) LDW-PSID-1", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
       lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")

plot_qte_top(qte.top5_cps_trim, qte.top5_cps_trim0, qte.top5_cps, all_plot_titles, main_start = 4)

plot_qte_top(qte.top5_psid_trim, qte.top5_psid_trim0, qte.top5_psid, all_plot_titles, main_start = 9)

plot_qte(qte.ldw_cps.trim, qte.ldw_cps.trim0, qte.trim.ldw_cps, main = "(N) LDW-CPS-1-PLUS (Trimmed)", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
       lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")

plot_qte(qte.ldw_psid.trim, qte.ldw_psid.trim0, qte.trim.ldw_psid, main = "(O) LDW-PSID-1-PLUS (Trimmed)", ylim)
legend("bottomleft", legend = c("Experimental", "Unadjusted", "Adjusted"), 
    lty = 1, pch = c(16, 17, 16), col = c(4, 2, 1), bty = "n")
```

These figures display QTET estimates derived from both the experimental and various observational samples. 
The QTETs estimated from LDW-Experimental (A), the LDW-CPS-1 sample (B), its top-ranked `nn_crump` (D), `caliper_crump` (E) and `genetic_ps_threshold` (H) subsamples as well as the trimmed and matched version of LDW-CPS-1-PLUS (N) continue to correspond well with the true QTET. 

The QTET estimates from the LDW-PSID-1 sample (C), its top-ranked subsamples and the trimmed and matched version of LDW-PSID-1-PLUS (O) show clear biases and noticeably wider confidence bands when compared to the experimental benchmark, indicating greater estimation uncertainty. 

Overall, these patterns mirror those observed in model A.
```{r, message=FALSE, warning=FALSE}
# list results
plots_ldw <- list(
  list(mod = qte.ldw_cps, mod0 = qte.ldw_cps0, bm = qte.ldw, main = "(B) LDW-CPS-1"),
  list(mod = qte.ldw_psid, mod0 = qte.ldw_psid0, bm = qte.ldw, main = "(C) LDW-PSID-1"),
  list(mod = qte.ldw_cps.trim, mod0 = qte.ldw_cps.trim0, bm = qte.trim.ldw_cps, main = "(N) LDW-CPS-1-PLUS (Trimmed)"),
  list(mod = qte.ldw_psid.trim, mod0 = qte.ldw_psid.trim0, bm = qte.trim.ldw_psid, main = "(O) LDW-PSID-1-PLUS (Trimmed)")
)

# save results
save_qtet(plots_ldw, prefix = "ldw_model_b")
save_qte_top(qte.top5_cps_trim, qte.top5_cps_trim0, qte.top5_cps, all_plot_titles, main_start = 8, prefix = "ldw_model_b_top")
save_qte_top(qte.top5_psid_trim, qte.top5_psid_trim0, qte.top5_psid, all_plot_titles, main_start = 13, prefix = "ldw_model_b_top")
```

### Assessing outcome weights (OW)
```{r, message=FALSE, warning=FALSE}
# list all datasets
all_datasets <- c(list(ldw, ldw_cps, ldw_psid), top5_datasets.cps, top5_datasets.psid, list(ldw_trim_cps, ldw_trim_psid))
```

```{r, message=FALSE, warning=FALSE}
# estimate ATT 
res_att <- get_res_att(all_datasets, Y, treat, covar)

# extract outcome weights
ow_att <- derive_ow(res_att)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGUREB5. SubfigureA:LDW-Experimental. SubfigureB:LDW-CPS-1. SubfigureC:LDW-PSID-1.  SubfigureD-H:Top-LDW-CPS-1. SubfigureI-M:Top-LDW-PSID-1. SubfigureN:LDW-CPS-1-PLUS. SubfigureO:LDW-PSID-1-PLUS. Outcome Weights Model B using LDW Data"}
par(mfrow = c(2,2))
par(cex.main = 0.9)

# plot outcome weights distribution
plot_ow(ow_att, all_plot_titles) 
```

```{r, message=FALSE, warning=FALSE}
# evaluate results
res_ow <- eval_ow(ow_att, all_datasets, all_plot_titles, treat, "AIPW-ATT")

# print table output
datatable(res_ow, caption = "Outcome Weights for Treated and Untreated",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

In model B, the evaluation once again confirms that, across each sample, the estimated outcome weights sum to one within the treated group and to minus one within the untreated group, yielding an overall total of zero. Note, that minor deviations from exact values are attributable to floating-point rounding error in numerical summation.
```{r, message=FALSE, warning=FALSE}
#save results
save_ow(ow_att, all_plot_titles, prefix = "ldw_model_b")
save_csv(res_ow, "ldw_model_b_ow")
```

## Validation through placebo analyses
```{r, message=FALSE, warning=FALSE}
# define variables
Y <- "re75"
treat <- "treat"
covar <- c("age", "education", "black", "hispanic", "married", "nodegree", "u74")
```

```{r, message=FALSE, warning=FALSE}
# estimate placebo ATT on original and observational samples
out1_pl <- estimate_all(ldw, Y, "treat", covar)
out2_pl <- estimate_all(ldw_cps, Y, "treat", covar)
out3_pl <- estimate_all(ldw_psid, Y, "treat", covar)
```

```{r, message=FALSE, warning=FALSE}
# estimate placebo ATT on top ranked samples
out.cps_pl <- lapply(top5_datasets.cps, function(d) estimate_all(d, Y, "treat", covar))
out.psid_pl <- lapply(top5_datasets.psid, function(d) estimate_all(d, Y, "treat", covar))
out.cps_trim_pl <- lapply(all_trim.cps, function(d) estimate_all(d, Y, "treat", covar))
out.psid_trim_pl <- lapply(all_trim.psid, function(d) estimate_all(d, Y, "treat", covar))
```

```{r, message=FALSE, warning=FALSE}
# estimate placebo ATT on plus samples
load("data/trimmed.RData")
out4_pl <- estimate_all(ldw_trim_cps_pl, Y, "treat", covar)
out5_pl <- estimate_all(ldw_trim_psid_pl, Y, "treat", covar)
out6_pl <- estimate_all(ldw_cps_trim_pl, Y, "treat", covar)
out7_pl <- estimate_all(ldw_psid_trim_pl, Y, "treat", covar)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGUREB6. SubfigureA:LDW-Experimental. SubfigureB:LDW-CPS-1. SubfigureD-H:Top-LDW-CPS-1. SubfigureC:LDW-PSID-1. SubfigureI-M:Top-LDW-PSID-1. SubfigureN:LDW-CPS-1-PLUS. SubfigureO:LDW-PSID-1-PLUS. Placebo Test Model B: '75 Earnings as the Outcome"}
par(mfrow = c(4, 1), mar = c(4, 4, 2, 1))

# experimental benchmarks
band.exp_pl <- out1_pl[1, 3:4]
est.exp_pl <- out1_pl[1, 1]

# plot placebo results
plot_coef(out1_pl,  band = band.exp_pl, line = est.exp_pl, 
          ylim = c(-15500, 5500), main = "(A) LDW-Experimental")

plot_coef(out2_pl,  band = band.exp_pl, line = est.exp_pl, 
          ylim = c(-15500, 5500), main = "(B) LDW-CPS-1")

plot_coef(out3_pl,  band = band.exp_pl, line = est.exp_pl,
          ylim = c(-15500, 5500), main = "(C) LDW-PSID-1")

# get nonexperimtenal benchmarks
method_names_cps <- sapply(top5_methods.cps, function(m) {
    matches <- names(out.cps_trim_pl)[sapply(names(out.cps_trim_pl), function(n) grepl(n, m, fixed=TRUE))]
    if (length(matches) > 0) matches[which.max(nchar(matches))] else NA 
})
method_names_psid <- sapply(top5_methods.psid, function(m) {
    matches <- names(out.psid_trim_pl)[sapply(names(out.psid_trim_pl), function(n) grepl(n, m, fixed=TRUE))]
    if (length(matches) > 0) matches[which.max(nchar(matches))] else NA 
})

band.cps_pl <- lapply(method_names_cps, function(j) {as.numeric(out.cps_trim_pl[[j]][1, 3:4])})
est.cps_pl  <- lapply(method_names_cps, function(j) out.cps_trim_pl[[j]][1, 1])
band.psid_pl <- lapply(method_names_psid, function(j) {as.numeric(out.psid_trim_pl[[j]][1, 3:4])})
est.psid_pl  <- lapply(method_names_psid, function(j) out.psid_trim_pl[[j]][1, 1])

# plot placebo results
for (i in seq_along(out.cps_pl)) {
  this_title <- paste0("(", LETTERS[i+3], ") Top CPS-1: ", top5_methods.cps[i])
  plot_coef(out.cps_pl[[i]], band = band.cps_pl[[i]], line = est.cps_pl[[i]],
            ylim = c(-15500, 5500), main = this_title)
}

for (i in seq_along(out.psid_pl)) {
  this_title <- paste0("(", LETTERS[i+8], ") Top PSID-1: ", top5_methods.psid[i])
  plot_coef(out.psid_pl[[i]], band = band.psid_pl[[i]], line = est.psid_pl[[i]],
            ylim = c(-15500, 5500), main = this_title)
}

# nonexperimtenal benchmarks
band.cps_plus_pl <- out4_pl[1, 3:4]
est.cps_plus_pl <- out4_pl[1, 1]
band.psid_plus_pl <- out5_pl[1, 3:4]
est.psid_plus_pl <- out5_pl[1, 1]

# plot placebo results
plot_coef(out6_pl, band = band.cps_plus_pl, line = est.cps_plus_pl, 
          ylim = c(-12000, 2000), main = "(N) Trimmed LDW-CPS-1-PLUS")

plot_coef(out7_pl, band = band.psid_plus_pl, line = est.psid_plus_pl, 
          ylim = c(-12000, 2000), main = "(O) Trimmed LDW-PSID-1-PLUS")
```

```{r, message=FALSE, warning=FALSE}
# combine results
all_outs_pl <- c(list(out1_pl, out2_pl, out3_pl), out.cps_pl, out.psid_pl, list(out6_pl, out7_pl))
all_bands_pl <- c(list(band.exp_pl, band.exp_pl, band.exp_pl), band.cps_pl, band.psid_pl, list(band.cps_plus_pl, band.psid_plus_pl))
all_ests_pl <- c(list(est.exp_pl, est.exp_pl, est.exp_pl), est.cps_pl, est.psid_pl, list(est.cps_plus_pl, est.psid_plus_pl))

# save results
save_att_panels(
    out_list    = all_outs_pl,
    plot_titles = all_plot_titles,
    band_list   = all_bands_pl,
    est_list    = all_ests_pl,
    prefix      = "ldw_model_b_pl_est_comb"
)
```

```{r, message=FALSE, warning=FALSE}
# get placebo results
all_outs_pl <- c(list(out1_pl, out2_pl, out3_pl), out.cps_pl, out.psid_pl, list(out6_pl, out7_pl))
out.cps_top_pl <- lapply(method_names_cps, function(j) out.cps_trim_pl[[j]])
out.psid_top_pl <- lapply(method_names_psid, function(j) out.psid_trim_pl[[j]])
all_out_mat_pl <- c(list(out1_pl), out.cps_top_pl, out.psid_top_pl, list(out4_pl, out5_pl))
result_mat_pl <- create_matrix_results(all_outs_pl, all_out_mat_pl, all_plot_titles)

# print table output
datatable(result_mat_pl, caption = "Placebo ATT Estimates and SEs",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

The placebo analysis shows that the experimental benchmarks remain close to zero and statistically insignificant, closely mirroring the results in model A. The results for LDW-CPS-1 and LDW-PSID-1 are similar to those observed in model A.

For LDW-CPS-1 subsamples (D-H), ATT estimates remain largely negative with only a few exceptions, with modest improvement toward the benchmark compared to LDW-CPS-1 (B) estimates and notably wider confidence intervals, revealing persistent imbalance and increased uncertainty. For LDW-PSID-1 subsamples (I-M), a similar pattern results compared to the LDW-PSID-1 sample. 

As in model A, the trimmed and matched versions of LDW-CPS-1-PLUS and LDW-PSID-1-PLUS exhibit even larger negative ATT estimates, continuing to reflect substantial bias and deviation from the true effect and highlighting the persistent challenges in adjusting for confounding using observational data.
```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(result_mat_pl, "ldw_att_estimates_pl_model_b")
```

## Validation through sensitivity analyses
```{r, message=FALSE, warning=FALSE}
# define variables
Y <- "re78"
treat <- "treat"
covar <- c("age", "education", "black", "hispanic", "married", "nodegree", "re75", "u74", "u75")
bm <- c("re75") 
```

```{r, message=FALSE, warning=FALSE}
# check for valid datasets 
filtered_datasets_sens <- check_filter_datasets(all_datasets, Y, treat, covar, bm)
```

```{r, message=FALSE, warning=FALSE, out.width='100%', fig.asp=1, fig.cap="FIGUREB7. SubfigureA:LDW-Experimental. SubfigureB:LDW-CPS-1. SubfigureD-H:Top-LDW-CPS-1. SubfigureC:LDW-PSID-1. SubfigureI-M:Top-LDW-PSID-1. SubfigureN:LDW-CPS-1-PLUS. SubfigureO:LDW-PSID-1-PLUS. Sensitivity Analyses Model B"}
par(mfrow = c(2,2))
par(cex.main = 0.8)

# loop over valid datasets and assign index
for (i in seq_along(filtered_datasets_sens)) {
    sens_ana(filtered_datasets_sens[[i]], Y, treat, covar, bm, kd = 1:3)
    title(main = all_plot_titles[i])
}
```

```{r, message=FALSE, warning=FALSE}
# save results
save_sensitivity_plots(filtered_datasets_sens, Y, treat, covar, bm, all_plot_titles, "ldw_model_b")
```

The sensitivity analysis demonstrates identical results for LDW-Experimental, LDW-CPS-1 and LDW-PSID-1 as in model A.

Specifically, it shows that for the LDW-Experimental sample, as well as for the LDW-CPS-1 and its top-ranked subsamples `nn_crump`, `caliper_crump` and `genetic_crump` (D-F) the estimated treatment effects are fairly robust to increasing confounder strength, as indicated by relatively stable values despite up to triple the correlation levels of the confounder. For the trimmed and matched LDW-CPS1-PLUS and LDW-PSID1-PLUS samples the estimated treatment effects remain also fairly robust, indicating improved resistance to unmeasured confounding due to this integrated approach. 

For two top-ranked subsamples of LDW-CPS-1, including `genetic_common_range` (G) and `genetic_ps_threshold` (H) and three top-ranked subsamples of LDW-PSID-1, including `optimal_pair_stuermer` (I), `k3_walker` (K) and `mahvars_stuermer` (L) the estimated treatment effect are reasonably sensitive to unmeasured confounding. In contrast, the LDW-PSID-1 sample (C) itself and its top-ranked subsamples `cs_stuermer` (J) and `genetic_stuermer` (M) produce treatment effects estimates that are even more sensitive to unmeasured confounding. 

Similar to model A, these results overall highlights sample-specific differences in robustness against potential unobserved confounding.

## Inspection of re74 and re75
### Correlation 
```{r, message=FALSE, warning=FALSE}
# compute correlations
cor_treat <- sapply(all_datasets, function(d) cor(d$re74, d$treat, use = "complete.obs"))
cor_outcome <- sapply(all_datasets, function(d) cor(d$re74, d$re78, use = "complete.obs"))
cor_cov <-  sapply(all_datasets, function(d) cor(d$re74, d$re75, use = "complete.obs"))
cor_table <- data.frame(Method = all_plot_titles, Cor_re74_treat = cor_treat, Cor_re74_out = cor_outcome, Cor_re74_re75 = cor_cov)

# print table output
datatable(cor_table, caption = "Correlations of re74 with treatment and outcome across samples",
          options = list(scrollX = TRUE, paging = FALSE, pageLength = -1, searching = FALSE))
```

The tabulated results demonstrate correlations patterns consistent with model A.
```{r, message=FALSE, warning=FALSE}
# save results 
save_csv(cor_table, "ldw_model_b_corr_results")
```

### Distributional balance
```{r, message=FALSE, warning=FALSE, fig.width=12, fig.height=3, out.width='100%', fig.cap="FIGUREB8. SubfigureA:LDW-Experimental. SubfigureB:LDW-CPS-1. SubfigureD-H:Top-LDW-CPS-1. SubfigureC:LDW-PSID-1. SubfigureI-M:Top-LDW-PSID-1. SubfigureN:LDW-CPS-1-PLUS. SubfigureO:LDW-PSID-1-PLUS. Balance Model B of re75"}
# re75
for (i in seq_along(top5_datasets.cps)) {
  tryCatch({
    plot_title <- paste0("(", LETTERS[i+3], ") CPS-1: ", top5_methods.cps[i], " - re75")
    print(bal.plot(treat ~ re75, data = top5_datasets.cps[[i]], which = "both") + 
            ggplot2::ggtitle(plot_title))
  }, error = function(e) {
    cat(sprintf("Could not plot %s: %s\n", top5_methods.cps[i], e$message))
  })
}

for (i in seq_along(top5_datasets.psid)) {
  tryCatch({
    plot_title <- paste0("(", LETTERS[i+8], ") PSID-1: ", top5_methods.psid[i], " - re75")
    print(bal.plot(treat ~ re75, data = top5_datasets.psid[[i]], which = "both") + 
            ggplot2::ggtitle(plot_title))
  }, error = function(e) {
    cat(sprintf("Could not plot %s: %s\n", top5_methods.psid[i], e$message))
  })
}
```

```{r, message=FALSE, warning=FALSE, fig.width=12, fig.height=3, out.width='100%', fig.cap="FIGUREB9. SubfigureA:LDW-Experimental. SubfigureB:LDW-CPS-1. SubfigureD-H:Top-LDW-CPS-1. SubfigureC:LDW-PSID-1. SubfigureI-M:Top-LDW-PSID-1. SubfigureN:LDW-CPS-1-PLUS. SubfigureO:LDW-PSID-1-PLUS. Balance Model B of re74"}
# re74
for (i in seq_along(top5_datasets.cps)) {
  tryCatch({
    plot_title <- paste0("(", LETTERS[i+3], ") CPS-1: ", top5_methods.cps[i], " - re74")
    print(bal.plot(treat ~ re74, data = top5_datasets.cps[[i]], which = "both") + 
            ggplot2::ggtitle(plot_title))
  }, error = function(e) {
    cat(sprintf("Could not plot %s: %s\n", top5_methods.cps[i], e$message))
  })
}

for (i in seq_along(top5_datasets.psid)) {
  tryCatch({
    plot_title <- paste0("(", LETTERS[i+8], ") PSID-1: ", top5_methods.psid[i], " - re74")
    print(bal.plot(treat ~ re74, data = top5_datasets.psid[[i]], which = "both") + 
            ggplot2::ggtitle(plot_title))
  }, error = function(e) {
    cat(sprintf("Could not plot %s: %s\n", top5_methods.psid[i], e$message))
  })
}
```

```{r, message=FALSE, warning=FALSE, fig.width=12, fig.height=3, out.width='100%'}
# save results
save_balance(top5_datasets.cps, top5_methods.cps, balance_var = "re75", prefix = "ldw_model_b_balance_panels_cps")
save_balance(top5_datasets.cps, top5_methods.cps, balance_var = "re74", prefix = "ldw_model_b_balance_panels_cps")
save_balance(top5_datasets.psid, top5_methods.psid, balance_var = "re75", prefix = "ldw_model_b_balance_panels_psid")
save_balance(top5_datasets.psid, top5_methods.psid, balance_var = "re74", prefix = "ldw_model_b_balance_panels_psid")
```

The density plots show that treated and control units do not substantially differ in `re74` across all samples, Although model B did not control for `re74`, this result suggests that the confounding bias from its omission is likely negligible
and that exclusion of it in the set of covariates may be justified.

## Summary
After reexamining model B, which uses the LaLonde-Dehejia-Wahba (LDW) data with a reduced set of covariates, we find that changing the covariate set leads to noticeable shifts in effect estimates. For LDW-CPS-1, estimates are generally more consistent and remain closer to the experimental benchmark, though standard errors are considerably large. In contrast, LDW-PSID-1 continues to show greater dispersion and substantially larger standard errors, highlighting persistent challenges with this observational sample.

Conditional and quantile treatment effect estimates confirm that, while some methods bring estimates closer to the experimental benchmark, considerable heterogeneity and estimator-dependent variability remain. Placebo tests using lagged earnings as the outcome reveal that, despite some improvements, bias and deviation from the true effect persist. Sensitivity analyses indicate that most treatment effect estimates are fairly sensitive to increasing confounder strength, but some upward shifts are observed compared to model A.

Further, the balance results suggest that excluding re74 from the covariate set incurs negligible confounding risk, thereby validating model B's specification.

Overall, these results reinforce the importance of overlap, covariate balance, and careful method selection, while underscoring the ongoing difficulty of recovering unbiased causal effects from observational data.